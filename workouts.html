<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack AI | Workouts</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #000000;
            --primary-text: #eaeaea;
            --secondary-text: #888888;
            --card-bg: #111111;
            --input-bg: #191919;
            --border-color: #222222;
            --accent: #FFFFFF;
            --accent-hover: #DDDDDD;
            --danger: #E53E3E;
            --edit: #3B82F6;
        }

        html, body {
            overscroll-behavior-y: contain;
        }

        body {
            background-color: var(--background);
            color: var(--primary-text);
            font-family: 'Manrope', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Add padding bottom for fixed mobile footer */
            padding-bottom: 3.5rem; 
        }
        
        body.menu-open {
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
            border-bottom: 2px solid transparent;
            color: var(--secondary-text);
            padding-bottom: 4px;
        }

        .nav-link:hover {
            color: var(--primary-text);
        }

        .nav-link.active {
            color: var(--primary-text);
            border-bottom-color: var(--primary-text);
        }

        .content-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem; /* Adjusted for mobile */
        }
        
        @media (min-width: 640px) {
            .content-card {
                padding: 2rem;
            }
        }


        .form-input, .form-select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .form-label {
            color: var(--secondary-text);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease-in-out;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transform: translateY(0);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--accent);
            color: var(--background);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--primary-text);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
        }
        
        .btn-danger {
            color: var(--danger);
        }
        
        .btn-danger:hover:not(:disabled) {
            background-color: rgba(229, 62, 62, 0.1);
        }

        .actions-dropdown {
            z-index: 50;
            background-color: var(--card-bg);
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            z-index: 100;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        /* MODIFICATION: Remove animation from exercise detail modal */
        #exercise-detail-modal, #exercise-detail-modal .modal-content {
            animation: none;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .loader {
            border: 2px solid #333;
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--input-bg); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .status-btn, .progress-range-btn {
            border: 1px solid var(--border-color);
            background-color: transparent;
            color: var(--secondary-text);
        }

        .status-btn.selected-full, .unit-toggle-btn.selected-full, .progress-range-btn.selected-full, #favorite-mode-toggle-btn.selected-full {
            background-color: #10b981;
            color: var(--background);
            border-color: #10b981;
        }
        #favorite-mode-toggle-btn.selected-full {
             background-color: #f59e0b;
             border-color: #f59e0b;
        }
        .status-btn.selected-partial {
            background-color: #fbbf24;
            color: var(--background);
            border-color: #fbbf24;
        }
        .status-btn.selected-none {
            background-color: #f87171;
            color: var(--background);
            border-color: #f87171;
        }
        
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary .lucide-chevron-down {
            transition: transform 0.2s ease-in-out;
        }
        details[open] > summary .lucide-chevron-down {
            transform: rotate(180deg);
        }
        
        .submenu {
            display: none;
        }
        .group.open > .submenu {
            display: block;
        }
        
        /* --- NEW & IMPROVED SWIPE STYLES --- */
        .swipe-item {
            position: relative;
            overflow: hidden;
            user-select: none;
        }
        .swipe-actions {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
        }
        .swipe-action-container {
            position: absolute;
            top: 0; bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            opacity: 0; /* Hidden by default */
            transition: opacity 0.3s ease;
        }
        .swipe-action-container.left {
            justify-content: flex-start;
            background: linear-gradient(to right, hsl(0, 72%, 51%), hsl(0, 82%, 61%));
        }
        .swipe-action-container.right {
            justify-content: flex-end;
            background: linear-gradient(to left, hsl(217, 91%, 60%), hsl(217, 81%, 70%));
        }
        .swipe-actions .action {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0 1.5rem;
        }
        .swipe-content {
            position: relative;
            background-color: var(--card-bg);
            touch-action: pan-y; /* Allow vertical scroll while capturing horizontal */
            cursor: pointer;
        }
        .swipe-content.swiping {
            transition: none; /* No transition while actively dragging */
        }
        .swipe-content.returning {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* --- ELEGANT INSTRUCTIONS TEXTAREA --- */
        #exercise-detail-instructions:disabled {
            background-color: transparent;
            border-color: transparent;
            padding-left: 0;
            padding-right: 0;
            color: var(--primary-text);
            line-height: 1.6;
            cursor: default;
        }
        
        /* --- UNDO TOAST --- */
        #undo-toast {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        #undo-toast.show {
            transform: translate(-50%, 0);
            opacity: 1;
        }

        /* --- DAY NAVIGATION SWIPE --- */
        #day-navigation-card {
            touch-action: pan-y;
            cursor: grab;
        }
        #day-navigation-card:active {
            cursor: grabbing;
        }
        
        /* Edit Plan Modal & Plan View Dragging Styles */
        .draggable-item, .plan-item-container[draggable="true"] {
            transition: background-color 0.2s ease;
            cursor: grab;
        }
        .draggable-item.dragging, .plan-item-container.dragging {
            opacity: 0.5;
            background-color: var(--input-bg);
        }
        .draggable-item .drag-handle, .plan-item-container[draggable="true"] {
            cursor: grab;
        }
        .draggable-item .drag-handle:active, .plan-item-container[draggable="true"]:active {
            cursor: grabbing;
        }
        .draggable-item.drag-over, .plan-item-container.drag-over {
            border-top: 2px solid var(--edit);
        }

        /* GIF ANIMATION STYLES REMOVED */
        #plan-main-title-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            color: var(--primary-text);
            font-size: 1.5rem; /* Match text-2xl */
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        @media (min-width: 640px) {
            #plan-main-title-input {
                font-size: 1.875rem; /* Match sm:text-3xl */
            }
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl px-2 sm:px-4 py-8">
        <!-- Header: Mobile Hamburger Removed. Desktop Nav remains. -->
        <header class="relative flex items-center justify-between mb-8 sm:mb-16 pb-4 border-b border-gray-900">
            <a href="index.html" class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m6 2 4 4"/><path d="m3 10.5 4.5-4.5"/><path d="m13.5 21 4.5-4.5"/></svg>
                <h1 class="text-2xl font-bold">FitTrack AI</h1>
            </a>
            <!-- Main Navigation (Desktop only) -->
            <nav id="main-nav" class="hidden md:flex md:items-center">
                <ul class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-6 text-sm sm:text-base font-medium">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="nutrition.html" class="nav-link">Nutrition</a></li>
                    <li><a href="workouts.html" class="nav-link active">Workouts</a></li>
                    <li><a href="goals.html" class="nav-link">Goals</a></li>
                    <li><a href="sleep.html" class="nav-link">Sleep</a></li>
                    <li><a href="settings.html" class="nav-link">Settings</a></li>
                </ul>
            </nav>
            <!-- Mobile Hamburger Button removed -->
        </header>
        
        <!-- Mobile Menu Overlay and Side Menu removed -->


        <main>
             <div class="flex flex-col sm:flex-row justify-between items-center mb-8 px-2">
                    <!-- Title Area: Used flex-grow to ensure it takes up maximum space and respects margins -->
                    <div class="flex-grow w-full overflow-hidden">
                        <!-- Double-tap to edit applied to this span -->
                        <span id="plan-main-title" class="text-2xl sm:text-3xl font-bold cursor-pointer inline-block" title="Double click to edit">Your Workout Plan</span>
                        <p id="plan-subtitle" class="text-gray-400 mt-1 sm:mt-2">Your personalized workout schedule.</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-4 sm:mt-0 w-full sm:w-auto">
                      <button id="edit-plan-btn" class="btn btn-secondary w-full sm:w-auto">
                          <i data-lucide="edit" class="w-4 h-4"></i>
                          <span>Edit Current Plan</span>
                      </button>
                      <button id="ai-plan-generator-btn" class="btn btn-primary w-full sm:w-auto">
                          <i data-lucide="wand-2" class="w-4 h-4"></i>
                          <span>New AI Plan</span>
                      </button>
                    </div>
                </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-8">
                <div id="day-navigation-card" class="lg:col-span-4 content-card">
                    <div id="plan-view-header" class="flex flex-col sm:flex-row justify-between items-center gap-4">
                           <div class="flex-1">
                               <button id="day-view-date-display-btn" class="text-left hover:bg-input-bg px-4 py-2 rounded-lg transition-colors w-full">
                                   <span id="day-view-title-span" class="text-xl sm:text-2xl font-semibold block"></span>
                                   <span id="day-view-date-span" class="text-sm sm:text-base text-secondary-text"></span>
                               </button>
                           </div>
                         <div class="flex flex-col items-center justify-center sm:justify-between gap-2">
                             <div class="flex items-center justify-center">
                                 <span id="day-view-status" class="text-sm font-bold text-secondary-text w-full sm:w-auto text-center"></span>
                                 <!-- REORGANIZE BUTTON REMOVED -->
                             </div>
                             <div id="workout-status-controls" class="flex gap-2 text-sm">
                                 <button class="status-btn btn !p-2 !py-1" data-status="full">Full</button>
                                 <button class="status-btn btn !p-2 !py-1" data-status="partial">Partial</button>
                                 <button class="status-btn btn !p-2 !py-1" data-status="none">None</button>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- Plan Card -->
                <div id="plan-history-container-card" class="content-card lg:col-span-4">
                    <div id="plan-history-grid" class="grid grid-cols-1 gap-x-8 gap-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2 border-b border-border-color pb-1">
                                <h5 class="font-semibold text-lg">Plan</h5>
                                <div class="flex items-center gap-2">
                                    <button id="add-temporary-exercise-btn" class="btn btn-secondary !p-1.5 hidden" title="Add Exercise for Today"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div id="workout-plan-for-day" class="space-y-2 max-h-[28rem] overflow-y-auto custom-scrollbar pr-2"></div>
                        </div>
                    </div>
                </div>

                <div class="content-card lg:col-span-4 lg:col-start-1">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h3 class="text-xl sm:text-2xl font-semibold">Progression Chart</h3>
                        <div class="flex gap-2 flex-wrap justify-center" id="progress-range-selector">
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="month">1M</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="3month">3M</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn selected-full" data-range="year">1Y</button>
                            <button class="btn btn-secondary !py-1 !px-3 text-xs progress-range-btn" data-range="all">All Time</button>
                        </div>
                        <select id="progress-exercise-select" class="w-full sm:w-auto form-select"></select>
                    </div>
                    <div class="w-full h-80 flex items-center justify-center">
                        <canvas id="progress-chart"></canvas>
                    </div>
                </div>
                 <div class="content-card lg:col-span-4">
                        <h3 class="text-xl sm:text-2xl font-semibold mb-4 text-center">AI Coach</h3>
                        
                        <div class="flex border-b border-border-color mb-4">
                            <button id="ai-tab-specific" class="flex-1 py-2 text-center font-semibold border-b-2 border-accent text-primary-text">Specific Advice</button>
                            <button id="ai-tab-general" class="flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-secondary-text">General Chat</button>
                        </div>

                        <div id="ai-panel-specific">
                            <p class="text-gray-400 text-sm mb-3 text-center">Select an exercise to get science-based advice on when to add weight or reps.</p>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <select id="ai-advice-exercise-select" class="w-full form-select">
                                    <option value="">Select an exercise...</option>
                                </select>
                                <button id="get-ai-advice-btn" class="btn btn-secondary w-full sm:w-auto">
                                    <span class="btn-text">Get Advice</span>
                                    <div class="loader hidden ml-2"></div>
                                </button>
                            </div>
                            <div id="ai-advice-output" class="mt-4 p-3 bg-black/30 rounded-md text-sm min-h-[50px]"></div>
                        </div>

                        <div id="ai-panel-general" class="hidden text-center">
                            <p class="text-gray-400 text-sm mb-4">Ask for specific advice about your plan, or have a general chat about your training.</p>
                            <div class="bg-black/30 p-4 rounded-lg">
                                <i data-lucide="message-circle" class="w-12 h-12 text-blue-400 mx-auto mb-4"></i>
                                <button id="open-workout-chat-btn" class="btn btn-primary w-full">Chat with AI Coach</button>
                            </div>
                        </div>
                    </div>
            </div>
        </main>
    </div>

    <!-- Mobile Footer Navigation (Instagram-style) -->
    <footer id="mobile-footer-nav" class="fixed bottom-0 left-0 right-0 h-14 bg-card-bg border-t border-border-color z-40 md:hidden">
        <nav class="flex justify-around items-center h-full">
            <a href="index.html" class="flex flex-col items-center justify-center p-2 text-secondary-text hover:text-primary-text">
                <i data-lucide="home" class="w-6 h-6"></i>
            </a>
            <a href="nutrition.html" class="flex flex-col items-center justify-center p-2 text-secondary-text hover:text-primary-text">
                <i data-lucide="carrot" class="w-6 h-6"></i>
            </a>
            <a href="workouts.html" class="flex flex-col items-center justify-center p-2 text-primary-text border-t-2 border-primary-text -mt-1 pt-1">
                <i data-lucide="dumbbell" class="w-6 h-6"></i>
            </a>
            <a href="goals.html" class="flex flex-col items-center justify-center p-2 text-secondary-text hover:text-primary-text">
                <i data-lucide="target" class="w-6 h-6"></i>
            </a>
            <a href="sleep.html" class="flex flex-col items-center justify-center p-2 text-secondary-text hover:text-primary-text">
                <i data-lucide="moon" class="w-6 h-6"></i>
            </a>
            <a href="settings.html" class="flex flex-col items-center justify-center p-2 text-secondary-text hover:text-primary-text">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </a>
        </nav>
    </footer>

    <!-- Modals here... -->
    <div id="ai-plan-generator-modal" class="modal-backdrop"><div class="modal-content !max-w-3xl"><div class="flex justify-between items-center mb-4"><h2 class="text-xl sm:text-2xl font-bold">AI Plan Generator</h2><button id="close-ai-plan-generator-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="ai-plan-panel"><form id="ai-plan-generator-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="ai-plan-goal" class="form-label">Primary Goal</label><select id="ai-plan-goal" class="form-select mt-1"><option value="muscle hypertrophy">Muscle Hypertrophy</option><option value="fat loss">Fat Loss</option><option value="body recomposition">Body Recomposition</option><option value="general fitness">General Fitness</option><option value="strength gain">Strength Gain</option><option value="custom">Custom</option></select></div><div id="ai-plan-split-container"><label for="ai-plan-split-select" class="form-label">Workout Split Template</label><select id="ai-plan-split-select" class="form-select mt-1"><option value="Push, Pull, Legs">Push, Pull, Legs</option><option value="Optimized PPL">Optimized PPL (Pre-built)</option><option value="Upper, Lower">Upper, Lower</option><option value="Full Body">Full Body</option></select></div></div><div id="ai-plan-goal-text-container" class="hidden"><label for="ai-plan-goal-text" class="form-label">Describe Your Goal</label><textarea id="ai-plan-goal-text" rows="2" class="form-input mt-1" placeholder="e.g., 'I want to build bigger arms and get a six-pack.'"></textarea></div><details class="pt-2" open><summary class="cursor-pointer text-sm text-gray-400 hover:text-white flex items-center justify-between"><span>Weekly Schedule & Duration</span><i data-lucide="chevron-down" class="w-4 h-4"></i></summary><div class="pt-4 mt-4 border-t border-gray-800 space-y-4"><p class="text-xs text-secondary-text">Click each day to cycle through available workout types to build your weekly schedule.</p><div id="ai-plan-schedule-builder"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="ai-plan-duration" class="form-label">Default Duration (minutes)</label><input type="number" id="ai-plan-duration" value="60" class="form-input mt-1"><button type="button" id="customize-duration-btn" class="text-sm text-blue-400 hover:underline mt-2">Customize per day</button><div id="ai-plan-durations-container" class="space-y-2 mt-2 hidden"></div></div><div><label for="ai-plan-rest" class="form-label">Rest Between Sets (minutes)</label><input type="number" id="ai-plan-rest" value="2" step="0.5" min="0" class="form-input mt-1"></div></div></div></details><details class="pt-2" open><summary class="cursor-pointer text-sm text-gray-400 hover:text-white flex items-center justify-between"><span>Equipment & Focus</span><i data-lucide="chevron-down" class="w-4 h-4"></i></summary><div class="space-y-4 pt-4 mt-4 border-t border-gray-800">
        <div>
            <div class="flex justify-between items-center mb-2">
                <label class="form-label">Equipment Available</label>
                <div class="flex gap-2">
                    <button type="button" class="text-xs text-blue-400 hover:underline select-all-btn" data-target="ai-plan-equipment-container">All</button>
                    <button type="button" class="text-xs text-blue-400 hover:underline deselect-all-btn" data-target="ai-plan-equipment-container">None</button>
                </div>
            </div>
            <div id="ai-plan-equipment-container" class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 mt-2"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="form-label">Focus Muscle Groups</label>
                    <div class="flex gap-2">
                        <button type="button" class="text-xs text-blue-400 hover:underline select-all-btn" data-target="ai-plan-focus-muscle-container">All</button>
                        <button type="button" class="text-xs text-blue-400 hover:underline deselect-all-btn" data-target="ai-plan-focus-muscle-container">None</button>
                    </div>
                </div>
                <div id="ai-plan-focus-muscle-container" class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2"></div>
            </div>
            <div><label for="ai-plan-unit" class="form-label">Weight Unit</label><select id="ai-plan-unit" class="form-select mt-1"><option value="kg">Kilograms (kg)</option><option value="lbs">Pounds (lbs)</option></select></div>
        </div>
    </div></details><details class="pt-2" open><summary class="cursor-pointer text-sm text-gray-400 hover:text-white flex items-center justify-between"><span>Exercise Preferences</span><i data-lucide="chevron-down" class="w-4 h-4"></i></summary><div id="ai-plan-exercise-prefs-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 pt-4 mt-4 border-t border-gray-800"></div></details><details class="pt-2"><summary class="cursor-pointer text-sm text-gray-400 hover:text-white flex items-center justify-between"><span>Advanced: Target Sets</span><i data-lucide="chevron-down" class="w-4 h-4"></i></summary><div class="pt-4 mt-4 border-t border-gray-800"><div class="mb-4"><label for="ai-plan-default-sets" class="form-label">Default Sets Per Muscle Group</label><input type="number" id="ai-plan-default-sets" class="form-input mt-1" placeholder="Auto"><button type="button" id="customize-sets-btn" class="text-sm text-blue-400 hover:underline mt-2">Customize per muscle group</button></div><div id="ai-plan-sets-container" class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 hidden"></div></div></details><button type="submit" class="w-full btn btn-primary !mt-6"><span class="btn-text">Generate My Plan</span><div class="loader hidden"></div></button></form><div id="ai-plan-output" class="mt-6 hidden"><div id="ai-plan-explanation" class="text-sm p-3 bg-black/30 rounded-lg mb-4"></div><pre id="ai-plan-json-output" class="hidden"></pre><div class="flex justify-end gap-4"><button id="cancel-new-plan-btn" class="btn btn-secondary">Cancel</button><button id="save-new-plan-btn" class="btn btn-primary">Save & Apply Plan</button></div></div></div></div></div>
    
    <!-- NEW EDIT PLAN MODAL -->
    <div id="edit-plan-modal" class="modal-backdrop">
        <div class="modal-content !max-w-4xl custom-scrollbar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl sm:text-2xl font-bold">Edit Current Plan</h2>
                <button id="close-edit-plan-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="space-y-8">
                 <div>
                        <h3 class="font-bold text-lg text-blue-400 mb-2">Weekly Schedule</h3>
                        <p class="text-sm text-secondary-text mb-4">Tap a day to cycle through your available workout types. This changes when you do each workout.</p>
                        <div id="edit-plan-schedule-builder" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2"></div>
                 </div>
                 <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Manage Warmups</h3>
                    <p class="text-sm text-secondary-text mb-4">Select a workout type to manage its warm-up routine.</p>
                    <div class="flex flex-col sm:flex-row gap-2 items-center mb-4">
                         <select id="edit-plan-warmup-day-type-select" class="form-select"></select>
                         <button id="edit-plan-add-warmup-btn" class="btn btn-secondary w-full sm:w-auto">
                             <i data-lucide="plus" class="w-4 h-4"></i>
                             <span>Add Warmup</span>
                         </button>
                    </div>
                    <div id="edit-plan-warmup-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 border border-border-color p-2 rounded-lg min-h-[100px]">
                    </div>
                 </div>
                <div>
                    <h3 class="font-bold text-lg text-blue-400 mb-2">Manage Workouts</h3>
                    <p class="text-sm text-secondary-text mb-4">Select a workout type to add, remove, or reorder its exercises.</p>
                    <div class="flex flex-col sm:flex-row gap-2 items-center mb-4">
                        <select id="edit-plan-day-type-select" class="form-select"></select>
                        <button id="edit-plan-add-exercise-btn" class="btn btn-secondary w-full sm:w-auto">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Add Exercise</span>
                        </button>
                    </div>
                    <div id="edit-plan-exercise-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2 border border-border-color p-2 rounded-lg min-h-[100px]">
                    </div>
                </div>
                <button id="save-plan-edits-btn" class="btn btn-primary w-full">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="custom-exercise-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 id="custom-exercise-modal-title" class="text-xl sm:text-2xl font-bold">Add Custom Exercise</h2><button id="close-custom-exercise-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div id="custom-exercise-initial-choice" class="flex gap-4"><button id="custom-exercise-ai-choice-btn" class="btn btn-primary w-full"><i data-lucide="sparkles"></i>Use AI</button><button id="custom-exercise-manual-choice-btn" class="btn btn-secondary w-full"><i data-lucide="edit-3"></i>Manual</button></div><form id="custom-exercise-form" class="hidden space-y-4 mt-4"><div><label for="custom-exercise-name" class="form-label">Exercise Name *</label><div class="flex gap-2"><input type="text" id="custom-exercise-name" class="form-input" required placeholder="e.g., Kneeling Landmine Press"><button type="button" id="ai-generate-exercise-details-btn" class="btn btn-secondary !px-3 hidden"><i data-lucide="sparkles"></i></button></div></div><div id="custom-exercise-details-container" class="space-y-4 pt-4 border-t border-border-color"><div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-border-color"><div id="custom-exercise-img-loader" class="loader hidden"></div><img id="custom-exercise-img" src="" class="w-full h-full object-contain hidden"></div><div class="grid grid-cols-2 gap-2"><label for="custom-img-upload" class="btn btn-secondary !py-1 text-xs cursor-pointer">Upload Image<input type="file" id="custom-img-upload" class="hidden" accept="image/*"></label><input type="url" id="custom-img-url" class="form-input !py-1 text-xs" placeholder="Or paste image/video URL"></div><div><label for="custom-exercise-instructions" class="form-label">Instructions</label><textarea id="custom-exercise-instructions" rows="5" class="form-input mt-1"></textarea></div><div><label for="custom-exercise-rep-range" class="form-label">Rep Range</label><input type="text" id="custom-exercise-rep-range" class="form-input mt-1"></div><div class="grid grid-cols-2 gap-4"><div><label for="custom-exercise-group" class="form-label">Muscle Group</label><select id="custom-exercise-group" class="form-select mt-1"></select></div><div><label for="custom-exercise-type" class="form-label">Equipment</label><select id="custom-exercise-type" class="form-select mt-1"></select></div></div><div id="custom-exercise-action-buttons" class="flex flex-col sm:flex-row gap-2 pt-2"></div></div></form></div></div>
    <div id="exercise-detail-modal" class="modal-backdrop"><div class="modal-content !max-w-xl custom-scrollbar"><div class="flex justify-between items-center mb-4"><h2 id="exercise-detail-title" class="text-xl sm:text-2xl font-bold">Exercise Details</h2><button id="close-exercise-detail-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="space-y-4">
        <!-- STATIC IMAGE PLACEHOLDER (ANIMATION REMOVED) -->
        <div class="w-full aspect-video bg-black rounded-lg flex items-center justify-center overflow-hidden border border-gray-800 relative">
            <div id="exercise-static-placeholder" class="w-full h-full flex items-center justify-center text-center text-gray-500 p-4 flex-col">
                <i data-lucide="dumbbell" class="w-12 h-12 text-gray-700 mb-2"></i>
                <span id="exercise-static-text" class="text-sm">Static Image Placeholder</span>
            </div>
        </div>
        <div><h3 class="font-bold text-lg text-blue-400 mb-2">Instructions</h3><textarea id="exercise-detail-instructions" class="form-input mt-1 w-full bg-input-bg text-sm transition-colors" disabled style="resize: none; overflow-y: hidden;"></textarea><button id="save-instructions-btn" class="mt-2 w-full btn btn-secondary">Edit Instructions</button></div><div class="grid grid-cols-2 gap-4"><div><h3 class="font-bold text-lg text-blue-400 mb-2">Sets</h3><p id="exercise-detail-sets" class="text-gray-300"></p></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Rep Range</h3><p id="exercise-detail-rep-range" class="text-gray-300"></p></div></div><div><h3 class="font-bold text-lg text-blue-400 mb-2">Personal Notes & Advice</h3><textarea id="exercise-detail-notes" rows="4" class="form-input mt-1" placeholder="Add your personal cues, weight progression goals, etc."></textarea><button id="save-exercise-notes-btn" class="mt-2 w-full btn btn-secondary">Save Notes</button></div><button id="log-from-detail-btn" class="w-full btn btn-primary mt-4">Log This Exercise</button></div></div></div>
    <div id="warmup-manage-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="warmup-form-title" class="text-xl sm:text-2xl font-bold">Manage Warm-up</h2><button id="close-warmup-manage-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="warmup-form" class="space-y-3"><div><label for="warmup-name" class="form-label">Name</label><input type="text" id="warmup-name" class="form-input mt-1" required></div><div><label for="warmup-instructions" class="form-label">Instructions (one per line)</label><textarea id="warmup-instructions" rows="4" class="form-input mt-1"></textarea></div><button type="submit" id="save-warmup-btn" class="w-full btn btn-primary">Add Warm-up</button></form></div></div>
    <div id="workout-modal" class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 id="modal-title" class="text-xl sm:text-2xl font-bold">Log Exercise</h2><div class="flex items-center gap-1 border border-border-color rounded-lg p-1"><button type="button" id="unit-toggle-kg" class="btn !py-1 !px-3 text-sm unit-toggle-btn">kg</button><button type="button" id="unit-toggle-lbs" class="btn !py-1 !px-3 text-sm unit-toggle-btn">lbs</button></div><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><form id="workout-log-form"><div class="space-y-4"><div id="sets-container"></div><button type="button" id="add-set-btn" class="w-full btn btn-secondary">Add Set</button><button type="submit" id="save-workout-btn" class="w-full btn btn-primary mt-2">Save Workout</button></div></form></div></div>
    <div id="exercise-library-modal" class="modal-backdrop"><div class="modal-content !max-w-2xl"><div class="flex justify-between items-center mb-4"><h2 class="text-xl sm:text-2xl font-bold" id="exercise-library-title">Exercise Library</h2><button id="close-exercise-library-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
    <div class="flex flex-wrap gap-2 mb-4">
        <input type="search" id="exercise-library-search" class="form-input flex-grow" placeholder="Search exercises...">
        <select id="exercise-library-filter" class="form-select w-full sm:w-48"><option value="">All Muscle Groups</option></select>
        <select id="exercise-library-equipment-filter" class="form-select w-full sm:w-48"><option value="">All Equipment</option></select>
        <button id="create-new-exercise-from-library-btn" class="btn btn-secondary !px-3" title="Create New Exercise"><i data-lucide="plus"></i></button>
    </div>
    <div id="exercise-library-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar pr-2"></div><button id="add-selected-exercises-btn" class="btn btn-primary w-full mt-4">Add Selected</button></div></div>
    <div id="confirm-modal" class="modal-backdrop"><div class="modal-content"><h2 id="confirm-modal-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-modal-text" class="text-gray-300 mb-6">This action cannot be undone.</p><div class="flex justify-end gap-4"><button id="confirm-modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="confirm-modal-confirm-btn" class="btn btn-danger">Confirm</button></div></div></div>
    <div id="alert-modal" class="modal-backdrop"><div class="modal-content"><h2 id="alert-modal-title" class="text-xl font-bold mb-4">Alert</h2><p id="alert-modal-text" class="text-gray-300 mb-6"></p><div class="flex justify-end"><button id="alert-modal-ok-btn" class="btn btn-primary">OK</button></div></div></div>
    
    <!-- NEW: Permanent Edit Warning Modal -->
    <div id="permanent-edit-warning-modal" class="modal-backdrop">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Permanent Edits</h2>
            <p class="text-gray-300 mb-6">To permanently edit an exercise's details (like instructions or name), please use the "Edit Current Plan" section or manage it in the Exercise Library. Swiping here only allows temporary, single-day removal.</p>
            <div class="flex items-center mb-6">
                <input type="checkbox" id="permanent-edit-dont-show-again" class="form-checkbox h-4 w-4 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500">
                <label for="permanent-edit-dont-show-again" class="ml-2 text-sm text-gray-400">Don't show this again</label>
            </div>
            <div class="flex justify-end">
                <button id="permanent-edit-ok-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Workout Coach Chat Modal -->
    <div id="ai-workout-chat-modal" class="modal-backdrop">
        <div class="modal-content !max-w-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">AI Workout Coach</h2>
                <button id="close-ai-workout-chat-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div id="ai-chat-history" class="flex-grow flex flex-col gap-4 overflow-y-auto custom-scrollbar pr-2 mb-4 min-h-[300px]"></div>
            <div class="flex gap-2">
                <input type="text" id="ai-chat-input" class="form-input" placeholder="Ask a fitness question...">
                <button id="ai-chat-send-btn" class="btn btn-primary"><i data-lucide="send"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Undo Toast Notification -->
    <div id="undo-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-4 transform translate-y-20 opacity-0 z-[200]">
        <span id="undo-toast-text"></span>
        <button id="undo-toast-btn" class="font-bold text-blue-400 hover:text-blue-300">Undo</button>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let workoutPlan = {};
            let workoutHistory = [];
            let exerciseDB = [];
            let warmups = {};
            let workoutStatusHistory = {};
            let userSettings = { unit: 'kg', showPermanentEditWarning: true };
            let workoutChatHistory = [];
            let dailyModifications = {}; // For temporary daily changes
            let lastLoggedSets = {}; // Stores the last logged weights/reps per exercise
            let currentlyLoggingExercise = null;
            let editingWorkoutLogId = null;
            let editingExerciseId = null;
            let editingWarmupIndex = null;
            let confirmCallback = null;
            let viewDate = new Date();
            viewDate.setHours(0,0,0,0);
            let isLogging = false; 
            let exercisePrefs = {}; // For AI plan generator
            let libraryModalContext = { purpose: 'add', group: '' }; // 'add' or 'pref'
            let restTimerInterval = null;
            let isAddingFromLibrary = false;
            let modalUnit = 'kg';
            let isNativeDragging = false; 
            let chartRange = 'year';
            
            // Undo Toast State
            let undoTimeout = null;
            let undoCallback = null;

            let ALL_MUSCLE_GROUPS = [];
            let ALL_EQUIPMENT_TYPES = [];
            const ALL_SPLIT_TYPES = ['Rest', 'Push', 'Pull', 'Legs', 'Upper', 'Lower', 'Full Body'];


            // --- UI ELEMENTS ---
            const ui = {
                workoutModal: document.getElementById('workout-modal'), modalTitle: document.getElementById('modal-title'), closeModalBtn: document.getElementById('close-modal-btn'),
                workoutLogForm: document.getElementById('workout-log-form'), setsContainer: document.getElementById('sets-container'), addSetBtn: document.getElementById('add-set-btn'), saveWorkoutBtn: document.getElementById('save-workout-btn'),
                confirmModal: document.getElementById('confirm-modal'), confirmModalTitle: document.getElementById('confirm-modal-title'), confirmModalText: document.getElementById('confirm-modal-text'),
                confirmModalCancelBtn: document.getElementById('confirm-modal-cancel-btn'), confirmModalConfirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                alertModal: document.getElementById('alert-modal'), alertModalTitle: document.getElementById('alert-modal-title'), alertModalText: document.getElementById('alert-modal-text'), alertModalOkBtn: document.getElementById('alert-modal-ok-btn'),
                exerciseLibraryModal: document.getElementById('exercise-library-modal'), closeExerciseLibraryModalBtn: document.getElementById('close-exercise-library-modal-btn'),
                exerciseLibraryTitle: document.getElementById('exercise-library-title'),
                addSelectedExercisesBtn: document.getElementById('add-selected-exercises-btn'),
                progressExerciseSelect: document.getElementById('progress-exercise-select'),
                aiAdviceExerciseSelect: document.getElementById('ai-advice-exercise-select'), getAIAdviceBtn: document.getElementById('get-ai-advice-btn'), aiAdviceOutput: document.getElementById('ai-advice-output'),
                exerciseDetailModal: document.getElementById('exercise-detail-modal'), closeExerciseDetailModalBtn: document.getElementById('close-exercise-detail-modal-btn'), exerciseDetailTitle: document.getElementById('exercise-detail-title'),
                exerciseStaticPlaceholder: document.getElementById('exercise-static-placeholder'),
                exerciseDetailInstructions: document.getElementById('exercise-detail-instructions'), saveInstructionsBtn: document.getElementById('save-instructions-btn'), exerciseDetailRepRange: document.getElementById('exercise-detail-rep-range'),
                exerciseDetailNotes: document.getElementById('exercise-detail-notes'), saveExerciseNotesBtn: document.getElementById('save-exercise-notes-btn'), logFromDetailBtn: document.getElementById('log-from-detail-btn'),
                dayViewDateDisplayBtn: document.getElementById('day-view-date-display-btn'), dayViewStatus: document.getElementById('day-view-status'), dayViewDateDisplay: document.getElementById('day-view-date-display-btn'),
                workoutPlanForDay: document.getElementById('workout-plan-for-day'),
                dayNavigationCard: document.getElementById('day-navigation-card'), 
                aiTabSpecific: document.getElementById('ai-tab-specific'), aiTabGeneral: document.getElementById('ai-tab-general'), aiPanelSpecific: document.getElementById('ai-panel-specific'), openWorkoutChatBtn: document.getElementById('open-workout-chat-btn'),
                workoutStatusControls: document.getElementById('workout-status-controls'),
                unitToggleKg: document.getElementById('unit-toggle-kg'), unitToggleLbs: document.getElementById('unit-toggle-lbs'),
                aiPlanGeneratorModal: document.getElementById('ai-plan-generator-modal'), closeAiPlanGeneratorModalBtn: document.getElementById('close-ai-plan-generator-modal-btn'),
                aiPlanGeneratorForm: document.getElementById('ai-plan-generator-form'), aiPlanGeneratorBtn: document.getElementById('ai-plan-generator-btn'),
                aiPlanScheduleBuilder: document.getElementById('ai-plan-schedule-builder'),
                aiPlanDurationsContainer: document.getElementById('ai-plan-durations-container'),
                aiPlanSetsContainer: document.getElementById('ai-plan-sets-container'), aiPlanOutput: document.getElementById('ai-plan-output'),
                aiPlanExplanation: document.getElementById('ai-plan-explanation'), aiPlanJsonOutput: document.getElementById('ai-plan-json-output'),
                cancelNewPlanBtn: document.getElementById('cancel-new-plan-btn'), saveNewPlanBtn: document.getElementById('save-new-plan-btn'),
                aiPlanPanel: document.getElementById('ai-plan-panel'),
                aiPlanExercisePrefsContainer: document.getElementById('ai-plan-exercise-prefs-container'),
                editPlanBtn: document.getElementById('edit-plan-btn'),
                customExerciseModal: document.getElementById('custom-exercise-modal'), closeCustomExerciseModalBtn: document.getElementById('close-custom-exercise-modal-btn'),
                customExerciseInitialChoice: document.getElementById('custom-exercise-initial-choice'), customExerciseAiChoiceBtn: document.getElementById('custom-exercise-ai-choice-btn'),
                customExerciseManualChoiceBtn: document.getElementById('custom-exercise-manual-choice-btn'),
                customExerciseForm: document.getElementById('custom-exercise-form'), customExerciseNameInput: document.getElementById('custom-exercise-name'),
                aiGenerateExerciseDetailsBtn: document.getElementById('ai-generate-exercise-details-btn'), customExerciseDetailsContainer: document.getElementById('custom-exercise-details-container'),
                customExerciseImgLoader: document.getElementById('custom-exercise-img-loader'), customExerciseImg: document.getElementById('custom-exercise-img'),
                customExerciseInstructions: document.getElementById('custom-exercise-instructions'), customExerciseRepRange: document.getElementById('custom-exercise-rep-range'),
                customExerciseGroup: document.getElementById('custom-exercise-group'),
                customExerciseActionButtons: document.getElementById('custom-exercise-action-buttons'),
                createNewExerciseFromLibraryBtn: document.getElementById('create-new-exercise-from-library-btn'),
                planViewHeader: document.getElementById('plan-view-header'),
                // Edit Plan Modal UI
                editPlanModal: document.getElementById('edit-plan-modal'),
                closeEditPlanModalBtn: document.getElementById('close-edit-plan-modal-btn'),
                editPlanScheduleBuilder: document.getElementById('edit-plan-schedule-builder'),
                editPlanDayTypeSelect: document.getElementById('edit-plan-day-type-select'),
                editPlanAddExerciseBtn: document.getElementById('edit-plan-add-exercise-btn'),
                editPlanExerciseList: document.getElementById('edit-plan-exercise-list'),
                savePlanEditsBtn: document.getElementById('save-plan-edits-btn'),
                editPlanWarmupDayTypeSelect: document.getElementById('edit-plan-warmup-day-type-select'),
                editPlanAddWarmupBtn: document.getElementById('edit-plan-add-warmup-btn'),
                editPlanWarmupList: document.getElementById('edit-plan-warmup-list'),
                // Mobile Menu removed
                // Permanent Edit Warning Modal
                permanentEditWarningModal: document.getElementById('permanent-edit-warning-modal'),
                permanentEditOkBtn: document.getElementById('permanent-edit-ok-btn'),
                permanentEditDontShowAgain: document.getElementById('permanent-edit-dont-show-again'),
            };

            // --- CHART.JS SETUP ---
            Chart.defaults.color = '#FFFFFF';
            const progressCtx = document.getElementById('progress-chart').getContext('2d');
            let progressChart = new Chart(progressCtx, {
                type: 'line', data: { labels: [], datasets: [] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } }, x: { ticks: { color: '#FFFFFF' }, grid: { color: 'rgba(255, 255, 255, 0.2)' } } }, plugins: { legend: { labels: { color: '#FFFFFF' } } } }
            });

            // --- IndexedDB for GIF Caching functions removed ---

            // --- LOCALSTORAGE & DATA FUNCTIONS ---
            function saveData() {
                localStorage.setItem('fitTrackAI_workoutPlan', JSON.stringify(workoutPlan));
                localStorage.setItem('fitTrackAI_workoutHistory', JSON.stringify(workoutHistory));
                const customExercises = exerciseDB.filter(ex => ex.isCustom);
                localStorage.setItem('fitTrackAI_exerciseDB', JSON.stringify(customExercises));
                localStorage.setItem('fitTrackAI_warmups', JSON.stringify(warmups));
                localStorage.setItem('fitTrackAI_workoutStatus', JSON.stringify(workoutStatusHistory));
                localStorage.setItem('fitTrackAI_userSettings', JSON.stringify(userSettings));
                localStorage.setItem('fitTrackAI_workoutChatHistory', JSON.stringify(workoutChatHistory));
                localStorage.setItem('fitTrackAI_dailyModifications', JSON.stringify(dailyModifications));
                // NEW: Save last logged sets
                localStorage.setItem('fitTrackAI_lastLoggedSets', JSON.stringify(lastLoggedSets));
            }
            
            async function loadAllData() {
                let baseExercises = [];
                let baseWarmups = {};
                try {
                    // Note: exercises.json must be present in the environment for the base exercises to load.
                    const response = await fetch('exercises.json');
                    if (!response.ok) throw new Error('Failed to fetch exercise data');
                    const data = await response.json();
                    baseExercises = data.exercises || [];
                    baseWarmups = data.warmups || {};
                } catch (error) {
                    console.error("Could not load exercises.json. The app might not function correctly without it.", error);
                    showCustomAlert("Error", "Could not load the base exercise library. Please check your connection or the exercises.json file.");
                }

                const localWorkoutPlan = JSON.parse(localStorage.getItem('fitTrackAI_workoutPlan')) || {};
                const localWorkoutHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutHistory')) || [];
                const customExercises = JSON.parse(localStorage.getItem('fitTrackAI_exerciseDB')) || [];
                const localWarmups = JSON.parse(localStorage.getItem('fitTrackAI_warmups')) || {};
                const localStatusHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutStatus')) || {};
                const localUserSettings = JSON.parse(localStorage.getItem('fitTrackAI_userSettings')) || { unit: 'kg', showPermanentEditWarning: true };
                const localChatHistory = JSON.parse(localStorage.getItem('fitTrackAI_workoutChatHistory')) || [];
                const localDailyModifications = JSON.parse(localStorage.getItem('fitTrackAI_dailyModifications')) || {};
                // NEW: Load last logged sets
                const localLastLoggedSets = JSON.parse(localStorage.getItem('fitTrackAI_lastLoggedSets')) || {};


                const baseExerciseIds = new Set(baseExercises.map(ex => ex.id));
                const uniqueCustomExercises = customExercises.filter(ex => !baseExerciseIds.has(ex.id));
                
                exerciseDB = [...baseExercises, ...uniqueCustomExercises];
                
                workoutPlan = localWorkoutPlan;
                workoutHistory = localWorkoutHistory;
                warmups = Object.keys(localWarmups).length > 0 ? localWarmups : baseWarmups;
                workoutStatusHistory = localStatusHistory;
                userSettings = {...{ unit: 'kg', showPermanentEditWarning: true }, ...localUserSettings}; // Ensure defaults
                workoutChatHistory = localChatHistory;
                dailyModifications = localDailyModifications;
                lastLoggedSets = localLastLoggedSets; // ASSIGN NEW STATE

                exerciseDB.forEach(ex => { if (!ex.id) ex.id = crypto.randomUUID(); });
                
                exerciseDB.forEach(ex => {
                    if (ex.group === "Abs") ex.group = "Abdominals";
                    if (["Lats", "Upper Back", "Lower Back", "Traps"].includes(ex.group)) ex.group = "Back";
                });

                ALL_MUSCLE_GROUPS = [...new Set(exerciseDB.map(ex => ex.group))].sort();
                ALL_EQUIPMENT_TYPES = [...new Set(exerciseDB.map(ex => ex.type))].sort();
            }

            // --- CORE & HELPER FUNCTIONS ---
            const getApiUrl = (model, action = 'generateContent') => {
                const apiKey = ""; // API key is handled by the environment
                return `https://generativelanguage.googleapis.com/v1beta/models/${model}:${action}?key=${apiKey}`;
            };
            
            function dateToKey(date) { return date.toISOString().split('T')[0]; }
            function showModal(modalElement) { modalElement.style.display = 'flex'; }
            function hideModal(modalElement) { modalElement.style.display = 'none'; }
            function showConfirmModal(title, text, onConfirm) { ui.confirmModalTitle.textContent = title; ui.confirmModalText.textContent = text; confirmCallback = onConfirm; showModal(ui.confirmModal); };
            function showCustomAlert(title, text) { ui.alertModalTitle.textContent = title; ui.alertModalText.textContent = text; showModal(ui.alertModal); };
            function updateUI() {
                updateDayView(viewDate);
                populateProgressSelect();
                renderProgressionChart(ui.progressExerciseSelect.value || 'today-general');
                document.getElementById('plan-main-title').textContent = workoutPlan.name || "Your Workout Plan";
                lucide.createIcons();
            }
            function kgToLbs(kg) { return kg * 2.20462; }
            function lbsToKg(lbs) { return lbs / 2.20462; }
            function formatWeight(weightKg) {
                if(!weightKg && weightKg !== 0) return `0 ${userSettings.unit}`;
                if (userSettings.unit === 'lbs') {
                    return `${kgToLbs(weightKg).toFixed(1)} lbs`;
                }
                return `${weightKg.toFixed(1)} kg`;
            }
            
            // New function to toggle favorite by name
            function toggleFavoriteByName(itemName) {
                const exIndex = exerciseDB.findIndex(ex => ex.name === itemName);
                if (exIndex > -1) {
                    exerciseDB[exIndex].favorite = !exerciseDB[exIndex].favorite;
                    saveData();
                    renderWorkoutPlanForDate(viewDate); // Re-render to update star visuals
                }
            }


            // --- UNDO TOAST FUNCTION ---
            function showUndoToast(message, onUndo) {
                const toast = document.getElementById('undo-toast');
                const toastText = document.getElementById('undo-toast-text');
                
                toastText.textContent = message;
                undoCallback = onUndo;

                clearTimeout(undoTimeout);

                toast.classList.add('show');

                undoTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                    undoCallback = null;
                }, 5000); // 5 second duration
            }

            // --- REST TIMER ---
            function stopRestTimer() {
                clearInterval(restTimerInterval);
                restTimerInterval = null;
                // Clear any remaining timer text
                const activeTimer = document.querySelector('.rest-timer-active');
                if (activeTimer) {
                    activeTimer.textContent = '';
                    activeTimer.classList.remove('rest-timer-active');
                }
            }

            function startRestTimer(timerSpot) {
                stopRestTimer(); // Stop any previous timer

                timerSpot.classList.add('rest-timer-active');
                
                let restSeconds = (workoutPlan.restTime || 2) * 60;

                const updateTimer = () => {
                    const minutes = Math.floor(restSeconds / 60);
                    const seconds = restSeconds % 60;
                    timerSpot.textContent = `Rest: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (restSeconds <= 0) {
                        stopRestTimer();
                        timerSpot.textContent = 'Rest Over!';
                        // Optional: play a sound or flash
                        setTimeout(() => { if (timerSpot.textContent === 'Rest Over!') timerSpot.textContent = ''; }, 3000);
                    } else {
                        restSeconds--;
                    }
                };

                updateTimer();
                restTimerInterval = setInterval(updateTimer, 1000);
            }


            // --- WORKOUT LOGGING FUNCTIONS ---
            function openWorkoutModal(exerciseName) {
                isLogging = true;
                editingWorkoutLogId = null;
                currentlyLoggingExercise = exerciseName;
                ui.modalTitle.textContent = `Log: ${exerciseName}`;
                ui.saveWorkoutBtn.textContent = 'Save Workout';
                ui.setsContainer.innerHTML = '';
                
                modalUnit = userSettings.unit; // Set modal unit based on user setting
                updateUnitToggleUI(modalUnit);

                const exerciseDetails = exerciseDB.find(ex => ex.name === exerciseName);
                let setsToRender = []; // Array to hold set data (in KG for internal consistency)

                // 1. Check for last logged data and use it for pre-fill
                if (lastLoggedSets[exerciseName] && lastLoggedSets[exerciseName].length > 0) {
                    setsToRender = lastLoggedSets[exerciseName];
                } else {
                    // 2. If no last logged data, default based on plan (existing logic)
                    let numSets = 3;
                    if (exerciseDetails && exerciseDetails.sets) {
                        const setsMatch = String(exerciseDetails.sets).match(/\d+/); // Get the first number (e.g., from "3-4")
                        if (setsMatch) {
                            numSets = parseInt(setsMatch[0], 10);
                        }
                    }
                    // Fill with default empty sets (in KG format)
                    for (let i = 0; i < numSets; i++) {
                        setsToRender.push([{weight: '', reps: '', partial: false}]);
                    }
                }
                
                // 3. Render the sets, performing KG -> LBS conversion if necessary inside addSetRow
                setsToRender.forEach(setParts => {
                    addSetRow(setParts);
                });
                
                showModal(ui.workoutModal);
            };

            function addSetRow(setParts = [{weight: '', reps: '', partial: false}]) {
                const setNumber = ui.setsContainer.children.length + 1;
                const row = document.createElement('div');
                row.className = 'set-row border border-gray-800 p-3 rounded-lg space-y-2';
                row.innerHTML = `<div class="flex justify-between items-center"><label class="font-bold text-lg">Set ${setNumber}</label><span class="rest-timer-spot text-sm text-blue-400 font-mono"></span><div><button type="button" class="add-part-btn text-blue-400 hover:text-blue-300 p-1" title="Add drop set / pyramid"><i data-lucide="plus-circle" class="w-5 h-5 pointer-events-none"></i></button><button type="button" class="remove-set-btn text-red-500 hover:text-red-400 p-1" title="Delete set"><i data-lucide="trash-2" class="w-5 h-5 pointer-events-none"></i></button></div></div><div class="parts-container space-y-2"></div>`;
                ui.setsContainer.appendChild(row);
                lucide.createIcons();
                
                const partsContainer = row.querySelector('.parts-container');
                setParts.forEach(part => {
                    // Convert stored KG weight (part.weight) to the current modal display unit
                    const displayWeight = modalUnit === 'lbs' ? (part.weight ? kgToLbs(part.weight).toFixed(1) : '') : (part.weight || '');
                    addWeightRepPart(partsContainer, displayWeight, part.reps, part.partial)
                });
                row.querySelector('.add-part-btn').addEventListener('click', () => addWeightRepPart(partsContainer));
            };

            function addWeightRepPart(container, weight='', reps='', isPartial=false) {
                const partHtml = `<div class="set-part-row grid grid-cols-12 gap-2 items-center"><input type="number" step="any" min="0" placeholder="Weight (${modalUnit})" value="${weight}" class="form-input !py-2 col-span-4 set-weight"><span class="text-center col-span-1">x</span><input type="number" min="1" step="1" placeholder="Reps" value="${reps}" class="form-input !py-2 col-span-3 set-reps"><div class="col-span-3 flex items-center justify-center"><input type="checkbox" ${isPartial ? 'checked' : ''} class="form-checkbox h-5 w-5 bg-input-bg border-border-color rounded text-blue-500 focus:ring-blue-500 set-partial"><label class="ml-2 text-sm">Partial</label></div><button type="button" class="remove-part-btn text-gray-500 hover:text-red-400 p-1 col-span-1"><i data-lucide="x-circle" class="w-4 h-4 pointer-events-none"></i></button></div>`;
                container.insertAdjacentHTML('beforeend', partHtml);
                lucide.createIcons();
            };
            
            // --- DAY VIEW & PLAN RENDERING ---
            function updateDayView(date) {
                viewDate = date;
                
                renderWorkoutPlanForDate(date);
                updateWorkoutStatusControls(date);

                const today = new Date(); today.setHours(0,0,0,0);
                const isToday = dateToKey(date) === dateToKey(today);
                const isFutureDay = date > today;

                ui.dayViewDateDisplay.querySelector('#day-view-title-span').textContent = date.toLocaleDateString(undefined, { weekday: 'long' }) + (isToday ? ' (Today)' : '');
                ui.dayViewDateDisplay.querySelector('#day-view-date-span').textContent = date.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });
                
                const addTempBtn = document.getElementById('add-temporary-exercise-btn');
                if (addTempBtn) addTempBtn.classList.toggle('hidden', isFutureDay);

                lucide.createIcons();
            }

            function getWorkoutDayType(date) {
                const schedule = workoutPlan.schedule || {};
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                return schedule[dayName] || 'Rest';
            }

            function renderWorkoutPlanForDate(date) {
                const dayType = getWorkoutDayType(date);
                const dateKey = dateToKey(date);
                const loggedExercisesForDay = new Set(workoutHistory.filter(log => log.date === dateKey).map(l => l.name));
                let exercisesHtml = '';

                const modsForDay = dailyModifications[dateKey] || { removed: [], added: [] };
                const removedExercises = new Set(modsForDay.removed);
                const addedExercises = modsForDay.added || [];

                const createExerciseHTML = (exName, type, isTemporary = false) => {
                    const ex = type === 'exercise' ? exerciseDB.find(e => e.name === exName) : { name: exName };
                    if (!ex) return '';
                    const isLogged = loggedExercisesForDay.has(ex.name);
                    const isFavorite = type === 'exercise' && ex.favorite;
                    
                    // Add cross for un-logged exercises
                    const statusIcon = isLogged
                        ? '<i data-lucide="check-circle-2" class="w-5 h-5 text-green-400"></i>'
                        : '<i data-lucide="x-circle" class="w-5 h-5 text-gray-600"></i>';
                    
                    const temporaryBadge = isTemporary ? '<span class="text-xs ml-2 bg-blue-500/30 text-blue-300 px-1.5 py-0.5 rounded">Today</span>' : '';

                    let buttonHtml = `
                        <button class="btn btn-secondary !p-2 info-btn" data-name="${ex.name}" data-type="${type}" data-day-type="${dayType}" title="View Info">
                            <i data-lucide="info" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    `;

                    return `
                        <div class="swipe-item plan-item-container rounded-lg" data-name="${ex.name}" data-type="${type}" data-day-type="${dayType}" draggable="true">
                            <div class="swipe-actions">
                                <div class="swipe-action-container left"><div class="action delete"><i data-lucide="trash-2" class="pointer-events-none"></i><span class="ml-2 pointer-events-none">Remove</span></div></div>
                                <div class="swipe-action-container right"><div class="action edit"><span class="mr-2 pointer-events-none">Edit</span><i data-lucide="pencil" class="pointer-events-none"></i></div></div>
                            </div>
                            <div class="swipe-content p-3 rounded-lg">
                                <div class="text-base text-gray-300 flex justify-between items-center group">
                                    <div class="flex-grow flex items-center gap-3">
                                        <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">${statusIcon}</div>
                                        <div>
                                            <span class="flex-grow text-left flex items-center">${ex.name}${temporaryBadge}</span>
                                            ${type === 'exercise' ? `<p class="text-xs text-blue-400">${ex.group}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- Favorite Star Indicator (Double-tap to toggle) -->
                                        ${isFavorite ? '<i data-lucide="star" class="w-4 h-4 fill-yellow-400 text-yellow-400"></i>' : ''}
                                        ${buttonHtml}
                                    </div>
                                </div>
                            </div>
                        </div>`;
                };

                if (dayType === 'Rest') {
                    exercisesHtml = `<div class="flex flex-col items-center justify-center h-full text-center p-4"><i data-lucide="bed-double" class="w-12 h-12 text-gray-500 mb-2"></i><p class="text-gray-500 italic mt-2">Rest Day</p></div>`;
                } else {
                    const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType);
                    const warmupExercises = warmups[dayType] || [];
                    
                    if (warmupExercises.length > 0) {
                        exercisesHtml += `<div><h5 class="font-semibold text-green-400 text-sm mb-1">Warm-up</h5><div class="space-y-1 warmup-list">${warmupExercises.map(w => createExerciseHTML(w.name, 'warmup')).join('')}</div></div>`;
                    }
                    
                    let planExercisesHtml = '';
                    if (workoutForDay && workoutForDay.exercises && workoutForDay.exercises.length > 0) {
                        const finalExercises = workoutForDay.exercises.filter(exName => !removedExercises.has(exName));
                        planExercisesHtml = finalExercises.map(exName => createExerciseHTML(exName, 'exercise', false)).join('');
                    }
                    
                    let temporaryExercisesHtml = addedExercises.map(exName => createExerciseHTML(exName, 'exercise', true)).join('');

                    if (planExercisesHtml || temporaryExercisesHtml) {
                        exercisesHtml += `<div><h5 class="font-semibold text-blue-400 text-sm my-2">Workout</h5><div class="space-y-1 exercise-list">${planExercisesHtml}${temporaryExercisesHtml}</div></div>`;
                    }
                    
                    if (!planExercisesHtml && !temporaryExercisesHtml && warmupExercises.length === 0) {
                        exercisesHtml += `<p class="text-secondary-text mt-4">No exercises planned for ${dayType} day. Use the Plan Editor to add some!</p>`;
                    }
                }
                ui.workoutPlanForDay.innerHTML = exercisesHtml;
                lucide.createIcons();
            }

            // --- HISTORY & STATUS FUNCTIONS ---
            function calculateAutoStatus(date) {
                const dayType = getWorkoutDayType(date);
                if (dayType === 'Rest') return 'full';
                const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType);
                const plannedExercises = workoutForDay?.exercises || [];
                if (plannedExercises.length === 0) return 'none';
                const dateKey = dateToKey(date);
                const loggedExercises = new Set(workoutHistory.filter(log => log.date === dateKey).map(log => log.name));
                const completedCount = plannedExercises.filter(ex => loggedExercises.has(ex)).length;
                if (completedCount === 0) return 'none';
                if (completedCount >= plannedExercises.length) return 'full';
                return 'partial';
            }

            function updateWorkoutStatusControls(date) {
                const dateKey = dateToKey(date);
                const today = new Date(); today.setHours(0,0,0,0);
                const isFutureDay = date > today;
                let currentStatus = workoutStatusHistory[dateKey];
                if(currentStatus === undefined || currentStatus === 'auto'){ currentStatus = calculateAutoStatus(date); }
                
                ui.workoutStatusControls.classList.toggle('hidden', isFutureDay);
                ui.workoutStatusControls.querySelectorAll('.status-btn').forEach(btn => {
                    btn.classList.remove('selected-full', 'selected-partial', 'selected-none');
                    if (btn.dataset.status === currentStatus) btn.classList.add(`selected-${currentStatus}`);
                });

                let statusText, statusClass;
                if (isFutureDay) { statusText = 'Plan for the Future'; statusClass = 'text-secondary-text'; } 
                else {
                    switch(currentStatus) {
                        case 'full': statusText = 'Workout: Full'; statusClass = 'text-green-400'; break;
                        case 'partial': statusText = 'Workout: Partial'; statusClass = 'text-yellow-400'; break;
                        case 'none': statusText = 'Workout: None'; statusClass = 'text-red-400'; break;
                        default: statusText = 'Status Not Logged'; statusClass = 'text-secondary-text';
                    }
                }
                ui.dayViewStatus.textContent = statusText;
                ui.dayViewStatus.className = `text-sm font-bold ${statusClass} w-full sm:w-auto text-center`;

                const dayType = getWorkoutDayType(date);
                const shouldShowReorganize = !isFutureDay && currentStatus === 'none' && dayType !== 'Rest';
                // Reorganize button logic removed as requested
            }

            // --- UNIFIED SWIPE & TAP HANDLERS (UPDATED FOR SCROLL/TAP DISTINCTION) ---
            let pointerStart = { x: 0, y: 0 };
            let currentX = 0;
            let isSwiping = false;
            let swipedElement = null;
            let lastTap = 0; // For double tap detection
            const MOVEMENT_TOLERANCE = 10; // Pixels allowed for tap vs scroll/drag distinction
            

            function handleItemDelete(element) {
                const name = element.dataset.name;
                const type = element.dataset.type;
                const dayType = element.dataset.dayType;
                const dateKey = dateToKey(viewDate);
                
                if (element.classList.contains('plan-item-container')) {
                    if (type === 'warmup') {
                        showConfirmModal('Delete Warmup?', `Permanently remove "${name}" from your ${dayType} warm-up?`, () => {
                            if(warmups[dayType]) {
                                warmups[dayType] = warmups[dayType].filter(w => w.name !== name);
                                saveData(); updateUI();
                            }
                        });
                        return;
                    }
                    
                    if (!dailyModifications[dateKey]) dailyModifications[dateKey] = { removed: [], added: [] };
                    const modsForDay = dailyModifications[dateKey];
                    const addedIndex = (modsForDay.added || []).indexOf(name);
                    
                    if (addedIndex > -1) {
                        modsForDay.added.splice(addedIndex, 1);
                        showUndoToast(`${name} removed for today.`, () => {
                            if (!modsForDay.added.includes(name)) modsForDay.added.push(name);
                            saveData(); updateUI();
                        });
                    } else {
                        if (!modsForDay.removed.includes(name)) modsForDay.removed.push(name);
                        showUndoToast(`${name} removed for today.`, () => {
                            const index = modsForDay.removed.indexOf(name);
                            if (index > -1) modsForDay.removed.splice(index, 1);
                            saveData(); updateUI();
                        });
                    }
                    saveData(); updateUI(); 

                } 
            }
            
            function handleItemEdit(element) {
                if (element.classList.contains('plan-item-container')) {
                    const name = element.dataset.name;
                    const type = element.dataset.type;
                    if (type === 'exercise') { showPermanentEditWarningModal(); } 
                    else if (type === 'warmup') { openEditPlanModal(); }
                } 
            }
            
            function showPermanentEditWarningModal() {
                if (userSettings.showPermanentEditWarning !== false) {
                    showModal(ui.permanentEditWarningModal);
                } else {
                    openEditPlanModal();
                }
            }

            function getPointerCoordinates(e) { return e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY }; }
            
            function handlePointerDown(e) {
                const target = e.target.closest('.swipe-item');
                if (!target || e.target.closest('button, a')) return;

                // Only start listening if user initiates drag or potential tap on mobile
                if (e.pointerType === 'touch' || e.pointerType === 'pen' || e.button === 0) { 
                    isNativeDragging = false;
                    const coords = getPointerCoordinates(e);
                    pointerStart.x = coords.x; pointerStart.y = coords.y;
                    currentX = 0; swipedElement = target;
                    swipedElement.querySelector('.swipe-content').classList.add('swiping');
                    
                    // Attach listeners for move and up events
                    document.addEventListener('mousemove', handlePointerMove); document.addEventListener('mouseup', handlePointerUp);
                    document.addEventListener('touchmove', handlePointerMove, { passive: false }); document.addEventListener('touchend', handlePointerUp);
                }
            }

            function handlePointerMove(e) {
                if (isNativeDragging) return;
                if (!swipedElement) return;
                const coords = getPointerCoordinates(e);
                const deltaX = coords.x - pointerStart.x; const deltaY = coords.y - pointerStart.y;
                
                // If it's mainly vertical, do nothing and let native scrolling take over.
                if (!isSwiping && Math.abs(deltaY) > MOVEMENT_TOLERANCE && Math.abs(deltaY) > Math.abs(deltaX)) {
                    // This was a scroll, not a swipe. Kill listeners.
                    handlePointerUp(); // Use handlePointerUp to clean up listeners and state, but don't execute action logic.
                    return; 
                }

                // Start swipe if enough horizontal movement occurred
                if (!isSwiping && Math.abs(deltaX) > MOVEMENT_TOLERANCE && Math.abs(deltaX) > Math.abs(deltaY)) isSwiping = true;
                
                if (isSwiping) {
                    if(e.cancelable) e.preventDefault();
                    currentX = deltaX;
                    const content = swipedElement.querySelector('.swipe-content');
                    content.style.transform = `translateX(${currentX}px)`;
                    const rightAction = swipedElement.querySelector('.swipe-action-container.right');
                    const leftAction = swipedElement.querySelector('.swipe-action-container.left');
                    if (currentX < 0) { rightAction.style.opacity = Math.min(1, Math.abs(currentX) / 80).toString(); leftAction.style.opacity = '0'; } 
                    else { leftAction.style.opacity = Math.min(1, currentX / 80).toString(); rightAction.style.opacity = '0'; }
                }
            }

            function handlePointerUp(e) {
                // Ensure cleanup always happens
                document.removeEventListener('mousemove', handlePointerMove); document.removeEventListener('mouseup', handlePointerUp);
                document.removeEventListener('touchmove', handlePointerMove); document.removeEventListener('touchend', handlePointerUp);
                if (!swipedElement) return;
                
                const elementToClean = swipedElement;
                const content = elementToClean.querySelector('.swipe-content');
                
                // Check if this was a very short, non-scrolling movement (a tap)
                const finalCoords = getPointerCoordinates(e);
                const movedX = Math.abs(finalCoords.x - pointerStart.x);
                const movedY = Math.abs(finalCoords.y - pointerStart.y);
                const isTap = movedX < MOVEMENT_TOLERANCE && movedY < MOVEMENT_TOLERANCE;

                if (isSwiping) {
                    const elementWidth = elementToClean.offsetWidth; const swipeThreshold = elementWidth * 0.35;
                    content.classList.add('returning');
                    if (currentX < -swipeThreshold) { handleItemEdit(elementToClean); content.style.transform = 'translateX(0)'; } 
                    else if (currentX > swipeThreshold) { handleItemDelete(elementToClean); } 
                    else { content.style.transform = 'translateX(0)'; }
                } else if (isTap) {
                     if (elementToClean.classList.contains('plan-item-container')) {
                        const today = new Date(); today.setHours(0,0,0,0);
                        const isFutureDay = viewDate > today;
                        const { name, type } = swipedElement.dataset;
                        
                        const currentTime = new Date().getTime();
                        const isDoubleTap = (currentTime - lastTap) < 300;
                        lastTap = currentTime;

                        if (type === 'exercise' && isDoubleTap) {
                            toggleFavoriteByName(name);
                            // Do nothing else on double tap
                        } else if (!isFutureDay && !isNativeDragging && type === 'exercise' && !isDoubleTap) {
                            // Single tap (log modal)
                            openWorkoutModal(name);
                        }
                    }
                }
                
                isSwiping = false; swipedElement = null; currentX = 0;
                
                setTimeout(() => {
                    content.classList.remove('swiping', 'returning');
                    content.style.transform = '';
                    elementToClean.querySelectorAll('.swipe-action-container').forEach(el => el.style.opacity = '0');
                }, 300);
            }

            // Day Navigation Swipe (UPDATED THRESHOLD)
            let dayNavPointerStart = { x: 0, y: 0 };
            let dayNavCurrentX = 0;
            let isDayNavSwiping = false;

            function handleDayNavPointerDown(e) {
                if (e.target.closest('.swipe-item, a, select, input')) return;
                const coords = getPointerCoordinates(e);
                dayNavPointerStart.x = coords.x; dayNavPointerStart.y = coords.y;
                dayNavCurrentX = 0; isDayNavSwiping = false;
                ui.dayNavigationCard.style.transition = 'none';
                document.addEventListener('mousemove', handleDayNavPointerMove); document.addEventListener('mouseup', handleDayNavPointerUp);
                document.addEventListener('touchmove', handleDayNavPointerMove, { passive: false }); document.addEventListener('touchend', handleDayNavPointerUp);
            }

            function handleDayNavPointerMove(e) {
                const coords = getPointerCoordinates(e);
                const deltaX = coords.x - dayNavPointerStart.x; const deltaY = coords.y - dayNavPointerStart.y;
                if (!isDayNavSwiping) {
                    if (Math.abs(deltaX) > 10 && Math.abs(deltaX) > Math.abs(deltaY)) isDayNavSwiping = true;
                    else if (Math.abs(deltaY) > 10) { handleDayNavPointerUp(); return; }
                }
                if (isDayNavSwiping) {
                    if(e.cancelable) e.preventDefault();
                    dayNavCurrentX = deltaX;
                    ui.dayNavigationCard.style.transform = `translateX(${dayNavCurrentX}px)`;
                    ui.dayNavigationCard.style.opacity = (1 - Math.abs(dayNavCurrentX) / ui.dayNavigationCard.offsetWidth).toString();
                }
            }

            function handleDayNavPointerUp() {
                document.removeEventListener('mousemove', handleDayNavPointerMove); document.removeEventListener('mouseup', handleDayNavPointerUp);
                document.removeEventListener('touchmove', handleDayNavPointerMove); document.removeEventListener('touchend', handleDayNavPointerUp);
                const swipeThreshold = 40; // REDUCED THRESHOLD

                ui.dayNavigationCard.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                if (isDayNavSwiping) {
                    if (dayNavCurrentX < -swipeThreshold) { // Swipe left for next day
                        viewDate.setDate(viewDate.getDate() + 1); 
                        updateUI(); 
                    } 
                    else if (dayNavCurrentX > swipeThreshold) { // Swipe right for previous day
                        viewDate.setDate(viewDate.getDate() - 1); 
                        updateUI(); 
                    }
                }
                ui.dayNavigationCard.style.transform = 'translateX(0)'; ui.dayNavigationCard.style.opacity = '1';
                isDayNavSwiping = false; dayNavCurrentX = 0;
                setTimeout(() => { ui.dayNavigationCard.style.transition = ''; }, 300);
            }

            // --- PLAN REORDERING DRAG & DROP ---
            let draggedPlanItem = null;

            function handlePlanDragStart(e) {
                if (!e.target.classList.contains('plan-item-container')) {
                    e.preventDefault();
                    return;
                }
                isNativeDragging = true; 
                draggedPlanItem = e.target;
                setTimeout(() => { if (draggedPlanItem) draggedPlanItem.classList.add('dragging'); }, 0);
            }

            function handlePlanDragEnd() {
                if (draggedPlanItem) {
                    draggedPlanItem.classList.remove('dragging');
                    draggedPlanItem = null;
                }
                document.querySelectorAll('.plan-item-container.drag-over').forEach(el => el.classList.remove('drag-over'));
                isNativeDragging = false;
            }
            
            function getDragAfterElementPlan(container, y) {
                const draggableElements = [...container.querySelectorAll('.plan-item-container:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                    else { return closest; }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function handlePlanDragOver(e) {
                e.preventDefault();
                const container = e.target.closest('.warmup-list, .exercise-list');
                if (!container || !draggedPlanItem) return;

                const draggedType = draggedPlanItem.dataset.type;
                if ((draggedType === 'warmup' && !container.classList.contains('warmup-list')) ||
                    (draggedType === 'exercise' && !container.classList.contains('exercise-list'))) {
                    return;
                }

                const afterElement = getDragAfterElementPlan(container, e.clientY);
                document.querySelectorAll('.plan-item-container.drag-over').forEach(el => el.classList.remove('drag-over'));
                if (afterElement) afterElement.classList.add('drag-over');
            }

            function handlePlanDrop(e) {
                e.preventDefault();
                const container = e.target.closest('.warmup-list, .exercise-list');
                if (!container || !draggedPlanItem) return;
                
                const draggedType = draggedPlanItem.dataset.type;
                if ((draggedType === 'warmup' && !container.classList.contains('warmup-list')) ||
                    (draggedType === 'exercise' && !container.classList.contains('exercise-list'))) {
                    handlePlanDragEnd();
                    return;
                }

                const afterElement = getDragAfterElementPlan(container, e.clientY);
                if (afterElement == null) { container.appendChild(draggedPlanItem); } 
                else { container.insertBefore(draggedPlanItem, afterElement); }

                const dayType = draggedPlanItem.dataset.dayType;
                if (container.classList.contains('warmup-list')) {
                    const newOrder = Array.from(container.querySelectorAll('.plan-item-container')).map(el => el.dataset.name);
                    const reorderedWarmups = newOrder.map(name => warmups[dayType].find(w => w.name === name)).filter(Boolean);
                    warmups[dayType] = reorderedWarmups;
                } else if (container.classList.contains('exercise-list')) {
                    const workout = workoutPlan.workouts.find(w => w.day === dayType);
                    if (workout) {
                        workout.exercises = Array.from(container.querySelectorAll('.plan-item-container')).map(el => el.dataset.name);
                    }
                }
                saveData();
                handlePlanDragEnd();
            }

            // --- EVENT LISTENERS ---
            ui.workoutPlanForDay.addEventListener('mousedown', handlePointerDown);
            ui.workoutPlanForDay.addEventListener('touchstart', handlePointerDown, { passive: true });
            
            ui.workoutPlanForDay.addEventListener('click', (e) => {
                const infoBtn = e.target.closest('.info-btn');
                if (infoBtn) {
                    const { name, type, dayType } = infoBtn.dataset;
                    openExerciseDetailModal(name, type, dayType);
                }
            });
            
            // --- PLAN TITLE EDIT LISTENERS ---
            function enableTitleEdit() {
                const titleSpan = document.getElementById('plan-main-title');
                const originalText = titleSpan.textContent;
                
                const input = document.createElement('input');
                input.id = 'plan-main-title-input';
                input.type = 'text';
                input.value = originalText;
                
                titleSpan.parentNode.replaceChild(input, titleSpan);
                input.focus();

                const saveEdit = () => {
                    const newTitle = input.value.trim() || "Your Workout Plan";
                    
                    workoutPlan.name = newTitle;
                    saveData();
                    
                    const newTitleSpan = document.createElement('span');
                    newTitleSpan.id = 'plan-main-title';
                    newTitleSpan.className = 'text-2xl sm:text-3xl font-bold cursor-pointer inline-block';
                    newTitleSpan.title = 'Double click to edit';
                    newTitleSpan.textContent = newTitle;
                    
                    input.parentNode.replaceChild(newTitleSpan, input);
                    
                    // Re-attach double-click listener to the new span
                    newTitleSpan.addEventListener('dblclick', enableTitleEdit);
                };

                input.addEventListener('blur', saveEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveEdit();
                    }
                });
            }

            document.addEventListener('dblclick', (e) => {
                if (e.target.id === 'plan-main-title') {
                    enableTitleEdit();
                }
            });


            document.getElementById('undo-toast-btn').addEventListener('click', () => {
                if (undoCallback) undoCallback();
                clearTimeout(undoTimeout); document.getElementById('undo-toast').classList.remove('show');
                undoCallback = null;
            });
            
            ui.closeExerciseLibraryModalBtn.addEventListener('click', () => hideModal(ui.exerciseLibraryModal));
            
            ui.addSelectedExercisesBtn.addEventListener('click', () => {
                const selected = Array.from(document.querySelectorAll('#exercise-library-list input:checked')).map(cb => cb.value);
                if (libraryModalContext.purpose === 'edit-plan-add') {
                    if (selected.length > 0) {
                        const dayType = libraryModalContext.dayType;
                        let workout = workoutPlan.workouts.find(w => w.day === dayType);
                        if (!workout) { workout = { day: dayType, exercises: [] }; workoutPlan.workouts.push(workout); }
                        const existingExercises = new Set(workout.exercises);
                        selected.forEach(name => existingExercises.add(name));
                        workout.exercises = Array.from(existingExercises);
                        renderExercisesForEdit(dayType);
                    }
                } else if (libraryModalContext.purpose === 'add-temporary') {
                    const { dateKey } = libraryModalContext;
                    if (selected.length > 0 && dateKey) {
                        if (!dailyModifications[dateKey]) {
                            dailyModifications[dateKey] = { removed: [], added: [] };
                        }
                        const existingAdded = new Set(dailyModifications[dateKey].added || []);
                        selected.forEach(name => existingAdded.add(name));
                        dailyModifications[dateKey].added = Array.from(existingAdded);
                        saveData();
                        updateUI();
                    }
                } else if (libraryModalContext.purpose === 'pref') {
                    const group = libraryModalContext.group;
                    const allInGroup = exerciseDB.filter(ex => ex.group === group).length;
                    if(selected.length === allInGroup) { delete exercisePrefs[group]; } 
                    else { exercisePrefs[group] = selected; }
                    renderExercisePreferences();
                }
                hideModal(ui.exerciseLibraryModal);
            });


            ui.getAIAdviceBtn.addEventListener('click', async () => {
                const exerciseName = ui.aiAdviceExerciseSelect.value;
                if (!exerciseName) { ui.aiAdviceOutput.innerHTML = `<p class="text-yellow-400">Please select an exercise first.</p>`; return; }
                const btn = ui.getAIAdviceBtn;
                btn.disabled = true; btn.querySelector('.btn-text').style.display = 'none'; btn.querySelector('.loader').classList.remove('hidden'); ui.aiAdviceOutput.innerHTML = '';
                const exerciseLogs = workoutHistory.filter(log => log.name === exerciseName).slice(-3);
                const prompt = `Act as an expert fitness coach. A user performed these recent sessions for ${exerciseName}: ${exerciseLogs.map((log, i) => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; return `Session ${i+1} (${new Date(log.date.replace(/-/g, '/')).toLocaleDateString()}): ${sets.map(set => set.map(part => `${part.weight}kg x ${part.reps} reps`).join(' + ')).join(', ')}`}).join('\n')} Based on progressive overload, give a clear, actionable recommendation for their *next* session. Be specific (e.g., "Aim for 6-8 reps with 52.5kg"). Keep it under 75 words.`;
                const apiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json(); let text = result.candidates[0].content.parts[0].text;
                    ui.aiAdviceOutput.innerHTML = `<p>${text}</p>`;
                } catch (error) { console.error("AI Workout Advice Error:", error); ui.aiAdviceOutput.innerHTML = `<p class="text-red-400">Could not get AI advice.</p>`;
                } finally { btn.disabled = false; btn.querySelector('.btn-text').style.display = 'inline'; btn.querySelector('.loader').classList.add('hidden'); }
            });

            ui.closeModalBtn.addEventListener('click', () => { hideModal(ui.workoutModal); isLogging = false; stopRestTimer(); });
            ui.addSetBtn.addEventListener('click', () => addSetRow());
            ui.alertModalOkBtn.addEventListener('click', () => hideModal(ui.alertModal));
            ui.confirmModalCancelBtn.addEventListener('click', () => hideModal(ui.confirmModal));
            ui.confirmModalConfirmBtn.addEventListener('click', () => { if(confirmCallback) confirmCallback(); hideModal(ui.confirmModal); });
            ui.progressExerciseSelect.addEventListener('change', (e) => renderProgressionChart(e.target.value));
            
            ui.dayViewDateDisplayBtn.addEventListener('click', () => { const today = new Date(); today.setHours(0,0,0,0); viewDate = today; updateUI(); });
            
            ui.workoutStatusControls.addEventListener('click', (e) => {
                const btn = e.target.closest('.status-btn');
                if (btn) { const status = btn.dataset.status; const dateKey = dateToKey(viewDate); workoutStatusHistory[dateKey] = status; saveData(); updateWorkoutStatusControls(viewDate); }
            });

            // Reorganize button logic removed

            document.getElementById('progress-range-selector').addEventListener('click', e => {
                const btn = e.target.closest('.progress-range-btn');
                if (btn) {
                    chartRange = btn.dataset.range;
                    document.querySelectorAll('.progress-range-btn').forEach(b => b.classList.remove('selected-full'));
                    btn.classList.add('selected-full');
                    renderProgressionChart(ui.progressExerciseSelect.value);
                }
            });

            function populateProgressSelect() {
                const currentSelection = ui.progressExerciseSelect.value;
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const singleExerciseOptions = exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                const dayType = getWorkoutDayType(new Date());
                const todayOptionText = dayType === 'Rest' ? "Overall Progression" : `Progression for ${dayType} Day`;
                ui.progressExerciseSelect.innerHTML = `<option value="today-general">${todayOptionText}</option><option value="general">Overall General Progression</option><optgroup label="Specific Exercises">${singleExerciseOptions}</optgroup>`;
                ui.progressExerciseSelect.value = currentSelection || 'today-general';
                ui.aiAdviceExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>' + singleExerciseOptions;
            };
            
            function getStartDateForRange(range) {
                const now = new Date();
                if (range === 'month') {
                    now.setMonth(now.getMonth() - 1);
                    return now;
                }
                if (range === '3month') {
                    now.setMonth(now.getMonth() - 3);
                    return now;
                }
                if (range === 'year') {
                    now.setFullYear(now.getFullYear() - 1);
                    return now;
                }
                return null; // for 'all'
            }

            function renderProgressionChart(selection) {
                if (selection === "today-general") { renderTodaysGeneralProgressionChart(); return; }
                if (selection === "general" || !selection) { renderGeneralProgressionChart(); return; }
                
                const startDate = getStartDateForRange(chartRange);
                let exerciseLogs = workoutHistory.filter(log => log.name === selection);
                if (startDate) {
                    exerciseLogs = exerciseLogs.filter(log => new Date(log.date) >= startDate);
                }
                exerciseLogs.sort((a,b) => new Date(a.date) - new Date(b.date));

                const labels = exerciseLogs.map(log => { if (!log.date || typeof log.date !== 'string') return 'Unknown'; return new Date(log.date.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); });
                
                const maxWeightData = exerciseLogs.map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const maxWeightKg = Math.max(...sets.flatMap(set => set.map(s => s.weight || 0))); return userSettings.unit === 'lbs' ? kgToLbs(maxWeightKg) : maxWeightKg; });
                
                const volumeData = exerciseLogs.map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const volumeKg = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0); return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });

                const est1RMData = exerciseLogs.map(log => {
                    const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets;
                    if (!sets || sets.length === 0) return null;
                    const max1RM = Math.max(...sets.flat().map(s => {
                        if (s.reps > 12 || s.reps < 1 || !s.weight) return null; // 1RM formulas are inaccurate for high reps
                        return s.weight * (1 + s.reps / 30); // Epley formula
                    }).filter(val => val !== null));
                    if (max1RM === -Infinity) return null;
                    return userSettings.unit === 'lbs' ? kgToLbs(max1RM) : max1RM;
                });

                progressChart.data.labels = labels;
                progressChart.data.datasets = [ 
                    { label: `Max Weight (${userSettings.unit})`, data: maxWeightData, borderColor: '#60a5fa', backgroundColor: '#60a5fa33', tension: 0.2, fill: true }, 
                    { label: `Total Volume (${userSettings.unit})`, data: volumeData, borderColor: '#4ade80', backgroundColor: '#4ade8033', tension: 0.2, fill: true },
                    { label: `Est. 1RM (${userSettings.unit})`, data: est1RMData, borderColor: '#facc15', backgroundColor: '#facc15', tension: 0.2, borderDash: [5, 5], fill: false } 
                ];
                progressChart.update();
            };

            function renderGeneralProgressionChart() {
                if (workoutHistory.length === 0) { progressChart.data.labels = []; progressChart.data.datasets = []; progressChart.update(); return; }
                const volumeByDay = {};
                const startDate = getStartDateForRange(chartRange);
                let relevantHistory = workoutHistory;
                if(startDate) {
                    relevantHistory = workoutHistory.filter(log => new Date(log.date) >= startDate);
                }

                relevantHistory.forEach(log => {
                    const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const dateKey = log.date;
                    const logVolume = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0);
                    if (!volumeByDay[dateKey]) { volumeByDay[dateKey] = 0; } volumeByDay[dateKey] += logVolume;
                });
                const sortedDates = Object.keys(volumeByDay).sort((a, b) => new Date(a) - new Date(b));
                const labels = sortedDates.map(dateStr => { if (!dateStr || typeof dateStr !== 'string') return 'Unknown'; return new Date(dateStr.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); });
                const volumeData = sortedDates.map(date => { const volumeKg = volumeByDay[date]; return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });
                progressChart.data.labels = labels;
                progressChart.data.datasets = [{ label: `Total Daily Volume (${userSettings.unit})`, data: volumeData, borderColor: '#a78bfa', backgroundColor: '#a78bfa33', tension: 0.2, fill: true }];
                progressChart.update();
            }

            function renderTodaysGeneralProgressionChart() {
                const dayType = getWorkoutDayType(new Date());
                if (dayType === 'Rest') { renderGeneralProgressionChart(); return; }
                const workoutForDay = (workoutPlan.workouts || []).find(w => w.day === dayType);
                if (!workoutForDay || !workoutForDay.exercises) { renderGeneralProgressionChart(); return; }
                
                const todaysExercises = new Set(workoutForDay.exercises);
                const volumeByDay = {};
                
                const startDate = getStartDateForRange(chartRange);
                let relevantHistory = workoutHistory;
                if(startDate) {
                    relevantHistory = workoutHistory.filter(log => new Date(log.date) >= startDate);
                }

                relevantHistory.filter(log => todaysExercises.has(log.name)).forEach(log => {
                    const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; const dateKey = log.date;
                    const logVolume = sets.flat().reduce((total, s) => total + (s.weight * s.reps), 0);
                    if (!volumeByDay[dateKey]) { volumeByDay[dateKey] = 0; } volumeByDay[dateKey] += logVolume;
                });
                if (Object.keys(volumeByDay).length === 0) { progressChart.data.labels = []; progressChart.data.datasets = [ { label: `Volume for Today's Workout (${userSettings.unit})`, data: [], borderColor: '#34d399', backgroundColor: '#34d39933', tension: 0.2, fill: true }]; progressChart.update(); return; }
                const sortedDates = Object.keys(volumeByDay).sort((a, b) => new Date(a) - new Date(b));
                const labels = sortedDates.map(dateStr => { if (!dateStr || typeof dateStr !== 'string') return 'Unknown'; return new Date(dateStr.replace(/-/g, '/')).toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); });
                const volumeData = sortedDates.map(date => { const volumeKg = volumeByDay[date]; return userSettings.unit === 'lbs' ? kgToLbs(volumeKg) : volumeKg; });
                progressChart.data.labels = labels;
                progressChart.data.datasets = [{ label: `Volume for Today's Workout (${userSettings.unit})`, data: volumeData, borderColor: '#34d399', backgroundColor: '#34d39933', tension: 0.2, fill: true }];
                progressChart.update();
            }
            
            function openEditWorkoutModal(logId) {
                const logEntry = workoutHistory.find(log => log.id === logId); if (!logEntry) return;
                isLogging = true; editingWorkoutLogId = logId; currentlyLoggingExercise = logEntry.name;
                ui.modalTitle.textContent = `Edit: ${logEntry.name}`; ui.saveWorkoutBtn.textContent = 'Update Workout';
                ui.setsContainer.innerHTML = '';
                const sets = typeof logEntry.sets === 'string' ? JSON.parse(logEntry.sets) : logEntry.sets;
                sets.forEach(set => addSetRow(set));
                modalUnit = userSettings.unit; updateUnitToggleUI(modalUnit);
                showModal(ui.workoutModal);
            };

            // --- GIF Generation & Display removed. Replaced with static placeholder ---
            function updateExerciseDetailStaticPlaceholder(exerciseName) {
                const staticTextElement = document.getElementById('exercise-static-text');
                if (staticTextElement) {
                    staticTextElement.textContent = `Static view of ${exerciseName} form.`;
                }
                lucide.createIcons(); // Re-render the icon
            }

            function openExerciseDetailModal(itemName, itemType = 'exercise', dayType = null) {
                let item;
                if (itemType === 'warmup') {
                    if (!dayType || !warmups[dayType]) return;
                    item = warmups[dayType].find(w => w.name === itemName);
                } else {
                    item = exerciseDB.find(ex => ex.name === itemName);
                }
                if (!item) return;

                currentlyLoggingExercise = item.name;
                ui.exerciseDetailTitle.textContent = item.name;

                updateExerciseDetailStaticPlaceholder(item.name);
                
                const instructions = Array.isArray(item.instructions) ? item.instructions : (item.instructions || "").split('\n');
                
                const instructionsTextarea = ui.exerciseDetailInstructions;
                instructionsTextarea.value = instructions.join('\n');
                
                setTimeout(() => {
                    instructionsTextarea.style.height = 'auto';
                    instructionsTextarea.style.height = (instructionsTextarea.scrollHeight) + 'px';
                }, 0);

                document.getElementById('exercise-detail-sets').textContent = item.sets ? `Aim for ${item.sets} sets.` : 'As needed.';
                ui.exerciseDetailRepRange.textContent = item.repRange ? `Aim for ${item.repRange}.` : 'No specific rep range.';
                ui.exerciseDetailNotes.value = item.notes || '';
                ui.logFromDetailBtn.style.display = itemType === 'warmup' ? 'none' : 'block';
                showModal(ui.exerciseDetailModal);
            }
            
            ui.closeExerciseDetailModalBtn.addEventListener('click', () => hideModal(ui.exerciseDetailModal));
            ui.logFromDetailBtn.addEventListener('click', () => { hideModal(ui.exerciseDetailModal); openWorkoutModal(currentlyLoggingExercise); });
            
            ui.saveInstructionsBtn.addEventListener('click', () => { 
                const btn = ui.saveInstructionsBtn; const textarea = ui.exerciseDetailInstructions;
                if(textarea.disabled){
                    textarea.disabled = false; btn.textContent = 'Save Changes'; btn.classList.add('btn-primary'); btn.classList.remove('btn-secondary');
                    textarea.focus();
                } else {
                    const exIndex = exerciseDB.findIndex(e => e.name === currentlyLoggingExercise); 
                    if (exIndex > -1) { 
                        exerciseDB[exIndex].instructions = textarea.value.split('\n').filter(line => line.trim() !== '');
                        saveData(); textarea.disabled = true;
                        btn.textContent = 'Saved!'; btn.classList.remove('btn-primary'); btn.classList.add('btn-secondary');
                        setTimeout(() => { btn.textContent = 'Edit Instructions'; }, 2000); 
                    }
                }
            });


            ui.saveExerciseNotesBtn.addEventListener('click', () => { 
                const exIndex = exerciseDB.findIndex(e => e.name === currentlyLoggingExercise); 
                if (exIndex > -1) { 
                    exerciseDB[exIndex].notes = ui.exerciseDetailNotes.value;
                    saveData();
                    const btn = ui.saveExerciseNotesBtn; btn.textContent = 'Saved!'; setTimeout(() => { btn.textContent = 'Save Notes'; }, 2000); 
                }
            });
            
             ui.workoutLogForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                 let formIsValid = true;
                 document.querySelectorAll('.set-row .set-part-row').forEach(partRow => {
                      partRow.querySelectorAll('input').forEach(input => input.classList.remove('!border-red-500'));
                      const weightInput = partRow.querySelector('.set-weight'), repsInput = partRow.querySelector('.set-reps');
                      const weight = parseFloat(weightInput.value), reps = parseFloat(repsInput.value);
                      if ((isNaN(weight) || weight < 0) && (isNaN(reps) || reps < 1)) return;
                      if (isNaN(weight) || weight < 0) { weightInput.classList.add('!border-red-500'); formIsValid = false; }
                      if (isNaN(reps) || reps < 1 || !Number.isInteger(reps)) { repsInput.classList.add('!border-red-500'); formIsValid = false; }
             });
             if(!formIsValid){ showCustomAlert("Invalid Input", "Weight must be a positive number and reps must be a positive whole number."); return; }
            
             const sets = Array.from(document.querySelectorAll('.set-row')).map(row => 
                 Array.from(row.querySelectorAll('.set-part-row')).map(partRow => {
                      let weightKg = parseFloat(partRow.querySelector('.set-weight').value) || 0;
                      if (modalUnit === 'lbs') { weightKg = lbsToKg(weightKg); }
                      return { weight: parseFloat(weightKg.toFixed(2)), reps: parseInt(partRow.querySelector('.set-reps').value) || 0, partial: partRow.querySelector('.set-partial').checked }
                 }).filter(p => p.reps > 0)
             ).filter(set => set.length > 0);

             if(sets.length === 0) return showCustomAlert('Empty Workout', 'Please log at least one valid set.');
             
             // NEW: Save the successful sets to lastLoggedSets
             lastLoggedSets[currentlyLoggingExercise] = sets; 

             const dateString = dateToKey(viewDate);
            
             if (editingWorkoutLogId) {
                 const logIndex = workoutHistory.findIndex(log => log.id === editingWorkoutLogId);
                 if(logIndex > -1){ workoutHistory[logIndex].sets = JSON.stringify(sets); workoutHistory[logIndex].date = dateString; workoutHistory[logIndex].name = currentlyLoggingExercise; workoutHistory[logIndex].createdAt = new Date().toISOString(); }
             } else { const newLog = { id: crypto.randomUUID(), name: currentlyLoggingExercise, date: dateString, sets: JSON.stringify(sets), createdAt: new Date().toISOString() }; workoutHistory.push(newLog); }

             editingWorkoutLogId = null;
             if (workoutStatusHistory[dateString] !== undefined) delete workoutStatusHistory[dateString];
             saveData(); updateUI(); hideModal(ui.workoutModal);
             isLogging = false; stopRestTimer();
            });

            ui.setsContainer.addEventListener('input', e => {
                if (e.target.classList.contains('set-weight') || e.target.classList.contains('set-reps')) {
                    const partRow = e.target.closest('.set-part-row'); const weightInput = partRow.querySelector('.set-weight'); const repsInput = partRow.querySelector('.set-reps');
                    if (parseFloat(weightInput.value) > 0 && parseInt(repsInput.value) > 0) { const timerSpot = partRow.closest('.set-row').querySelector('.rest-timer-spot'); startRestTimer(timerSpot); }
                }
            });

            ui.setsContainer.addEventListener('click', (e) => {
                const removeSetBtn = e.target.closest('.remove-set-btn'); const removePartBtn = e.target.closest('.remove-part-btn');
                if (removeSetBtn) { removeSetBtn.closest('.set-row').remove(); document.querySelectorAll('.set-row').forEach((row, index) => { row.querySelector('label').textContent = `Set ${index + 1}`; }); }
                else if (removePartBtn) { const partRow = removePartBtn.closest('.set-part-row'), partsContainer = partRow.parentElement; if (partsContainer.children.length > 1) { partRow.remove(); } else { showCustomAlert("Action blocked", "A set must have at least one part."); } }
            });

            // Reorganize button logic removed

            document.getElementById('progress-range-selector').addEventListener('click', e => {
                const btn = e.target.closest('.progress-range-btn');
                if (btn) {
                    chartRange = btn.dataset.range;
                    document.querySelectorAll('.progress-range-btn').forEach(b => b.classList.remove('selected-full'));
                    btn.classList.add('selected-full');
                    renderProgressionChart(ui.progressExerciseSelect.value);
                }
            });

            function populateProgressSelect() {
                const currentSelection = ui.progressExerciseSelect.value;
                const exercisedNames = [...new Set(workoutHistory.map(log => log.name))].sort();
                const singleExerciseOptions = exercisedNames.map(name => `<option value="${name}">${name}</option>`).join('');
                const dayType = getWorkoutDayType(new Date());
                const todayOptionText = dayType === 'Rest' ? "Overall Progression" : `Progression for ${dayType} Day`;
                ui.progressExerciseSelect.innerHTML = `<option value="today-general">${todayOptionText}</option><option value="general">Overall General Progression</option><optgroup label="Specific Exercises">${singleExerciseOptions}</optgroup>`;
                ui.progressExerciseSelect.value = currentSelection || 'today-general';
                ui.aiAdviceExerciseSelect.innerHTML = '<option value="">Select an exercise...</option>' + singleExerciseOptions;
            };
            
            function getStartDateForRange(range) {
                const now = new Date();
                if (range === 'month') {
                    now.setMonth(now.getMonth() - 1);
                    return now;
                }
                if (range === '3month') {
                    now.setMonth(now.getMonth() - 3);
                    return now;
                }
                if (range === 'year') {
                    now.setFullYear(now.getFullYear() - 1);
                    return now;
                }
                return null; // for 'all'
            }

            // Chart rendering functions remain the same...

            // Custom Exercise AI Listeners
            function openCustomExerciseModal(exercise = null) {
                ui.customExerciseForm.reset(); ui.customExerciseDetailsContainer.classList.add('hidden');
                ui.customExerciseInitialChoice.classList.add('hidden'); // Start hidden for a cleaner reset
                ui.customExerciseInitialChoice.classList.remove('hidden'); // Show choice for new exercises
                ui.customExerciseGroup.innerHTML = ALL_MUSCLE_GROUPS.map(g => `<option value="${g}">${g}</option>`).join('');
                document.getElementById('custom-exercise-type').innerHTML = ALL_EQUIPMENT_TYPES.map(g => `<option value="${g}">${g}</option>`).join('');
                editingExerciseId = exercise ? exercise.id : null;
                if(exercise) {
                    ui.customExerciseInitialChoice.classList.add('hidden'); ui.customExerciseForm.classList.remove('hidden'); ui.customExerciseDetailsContainer.classList.remove('hidden');
                    ui.customExerciseNameInput.value = exercise.name;
                    ui.customExerciseInstructions.value = Array.isArray(exercise.instructions) ? exercise.instructions.join('\n') : '';
                    ui.customExerciseRepRange.value = exercise.repRange || ''; ui.customExerciseGroup.value = exercise.group; document.getElementById('custom-exercise-type').value = exercise.type;
                    if(exercise.videoPlaceholder && (exercise.videoPlaceholder.startsWith('http') || exercise.videoPlaceholder.startsWith('data:'))){ ui.customExerciseImg.src = exercise.videoPlaceholder; ui.customExerciseImg.classList.remove('hidden'); } 
                    else { ui.customExerciseImg.classList.add('hidden'); }
                    ui.customExerciseActionButtons.innerHTML = ` <button type="submit" id="save-custom-exercise-changes-btn" class="btn btn-primary w-full">Save Changes</button> <button type="button" id="save-as-variation-btn" class="btn btn-secondary w-full">Save as New Variation</button> `;
                } else { ui.customExerciseActionButtons.innerHTML = '<button type="submit" id="save-new-custom-exercise-btn" class="w-full btn btn-primary">Save Custom Exercise</button>'; }
                showModal(ui.customExerciseModal);
            }

            ui.customExerciseAiChoiceBtn.addEventListener('click', () => {
                ui.customExerciseInitialChoice.classList.add('hidden'); ui.customExerciseForm.classList.remove('hidden');
                ui.aiGenerateExerciseDetailsBtn.classList.remove('hidden'); ui.customExerciseDetailsContainer.classList.add('hidden');
            });
            ui.customExerciseManualChoiceBtn.addEventListener('click', () => {
                ui.customExerciseInitialChoice.classList.add('hidden'); ui.customExerciseForm.classList.remove('hidden');
                ui.aiGenerateExerciseDetailsBtn.classList.add('hidden'); ui.customExerciseDetailsContainer.classList.remove('hidden');
                ui.customExerciseImg.classList.add('hidden'); ui.customExerciseImgLoader.classList.add('hidden');
            });

            ui.closeCustomExerciseModalBtn.addEventListener('click', () => {
                hideModal(ui.customExerciseModal);
                if (isAddingFromLibrary) { openExerciseLibrary(libraryModalContext.group); isAddingFromLibrary = false; } 
                 if (document.getElementById('edit-plan-modal').style.display === 'none' && !isAddingFromLibrary) {
                     const lastActiveDay = ui.editPlanDayTypeSelect.value;
                     if(lastActiveDay){ openEditPlanModal(); ui.editPlanDayTypeSelect.value = lastActiveDay; renderExercisesForEdit(lastActiveDay); }
                 }
            });

            ui.aiGenerateExerciseDetailsBtn.addEventListener('click', async () => {
                const exerciseName = ui.customExerciseNameInput.value.trim();
                if(!exerciseName) { showCustomAlert("Input Needed", "Please enter an exercise name first."); return; }
                const btn = ui.aiGenerateExerciseDetailsBtn; btn.disabled = true;
                const originalIcon = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>';
                ui.customExerciseDetailsContainer.classList.remove('hidden'); ui.customExerciseImg.classList.add('hidden'); ui.customExerciseImgLoader.classList.remove('hidden');
                try {
                    const textPrompt = `Generate a concise set of instructions and a recommended rep range for hypertrophy for the exercise: '${exerciseName}'. Respond in a valid JSON object with keys "instructions" (an array of strings) and "repRange" (a string).`;
                    const textApiUrl = getApiUrl('gemini-2.5-flash-preview-05-20');
                    const textResponse = await fetch(textApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }], generationConfig: { responseMimeType: "application/json" } }) });
                    if (!textResponse.ok) throw new Error(`Text Gen Error: ${textResponse.status}`);
                    const textResult = await textResponse.json(); const details = JSON.parse(textResult.candidates[0].content.parts[0].text);
                    ui.customExerciseInstructions.value = details.instructions.join('\n'); ui.customExerciseRepRange.value = details.repRange;
                    
                    // No image generation/caching, just display placeholder
                    updateExerciseDetailStaticPlaceholder(exerciseName); 
                } catch (error) { 
                    console.error("AI Custom Exercise Error:", error); 
                    showCustomAlert("AI Error", "Could not generate all details. Please try again or fill them manually.");
                } finally { 
                    ui.customExerciseImgLoader.classList.add('hidden'); 
                    ui.customExerciseImg.classList.remove('hidden'); 
                    btn.disabled = false; btn.innerHTML = originalIcon; lucide.createIcons(); 
                }
            });

            document.getElementById('custom-img-upload').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { ui.customExerciseImg.src = e.target.result; ui.customExerciseImg.classList.remove('hidden'); ui.customExerciseImgLoader.classList.add('hidden'); };
                    reader.readAsDataURL(file);
                }
            });

            function handleSaveCustomExercise(isNewVariation = false) {
             const newExerciseData = { id: (editingExerciseId && !isNewVariation) ? editingExerciseId : crypto.randomUUID(), isCustom: true, name: ui.customExerciseNameInput.value.trim(), instructions: ui.customExerciseInstructions.value.split('\n').filter(Boolean), repRange: ui.customExerciseRepRange.value, group: document.getElementById('custom-exercise-group').value, type: document.getElementById('custom-exercise-type').value, videoPlaceholder: document.getElementById('custom-img-url').value.trim() || ui.customExerciseImg.src, notes: '', favorite: false, };
             if (!newExerciseData.name || !newExerciseData.group) { showCustomAlert("Missing Info", "Exercise name and muscle group are required."); return; }
             const isNameDuplicate = exerciseDB.some(ex => ex.name.toLowerCase() === newExerciseData.name.toLowerCase() && ex.id !== newExerciseData.id);
             if (isNameDuplicate) { showCustomAlert("Duplicate Name", "An exercise with this name already exists. Please choose a different name."); return; }
             if (editingExerciseId && !isNewVariation) { const index = exerciseDB.findIndex(ex => ex.id === editingExerciseId); if (index > -1) exerciseDB[index] = { ...exerciseDB[index], ...newExerciseData }; } 
             else { exerciseDB.push(newExerciseData); }
             saveData(); hideModal(ui.customExerciseModal);
             showCustomAlert("Success", `Exercise "${newExerciseData.name}" has been saved!`);
             if (isAddingFromLibrary) { openExerciseLibrary(libraryModalContext.group); isAddingFromLibrary = false; } 
             else { updateUI(); }
            }
            
            ui.customExerciseForm.addEventListener('submit', (e) => { e.preventDefault(); handleSaveCustomExercise(false); });
            ui.customExerciseActionButtons.addEventListener('click', e => { if(e.target.id === 'save-as-variation-btn'){ handleSaveCustomExercise(true); } });
            ui.createNewExerciseFromLibraryBtn.addEventListener('click', () => { isAddingFromLibrary = true; hideModal(ui.exerciseLibraryModal); openCustomExerciseModal(); });

            document.getElementById('exercise-library-list').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-exercise-library-btn'); const deleteBtn = e.target.closest('.delete-exercise-library-btn');
                if (editBtn) { const exercise = exerciseDB.find(ex => ex.id === editBtn.dataset.id); if(exercise) { isAddingFromLibrary = true; hideModal(ui.exerciseLibraryModal); openCustomExerciseModal(exercise); } }
                if (deleteBtn) {
                    const exId = deleteBtn.dataset.id; const exName = exerciseDB.find(ex => ex.id === exId)?.name || 'this exercise';
                    showConfirmModal('Delete Exercise?', `Are you sure you want to permanently delete "${exName}"? This cannot be undone.`, () => {
                        exerciseDB = exerciseDB.filter(ex => ex.id !== exId);
                        if(workoutPlan.workouts) { workoutPlan.workouts.forEach(w => { w.exercises = w.exercises.filter(name => name !== exName); }); }
                        saveData(); openExerciseLibrary(libraryModalContext.group); updateUI();
                    });
                }
            });

            function updateUnitToggleUI(unit) {
                modalUnit = unit; ui.unitToggleKg.classList.toggle('selected-full', unit === 'kg'); ui.unitToggleLbs.classList.toggle('selected-full', unit === 'lbs');
                ui.workoutModal.querySelectorAll('.set-weight').forEach(input => { input.placeholder = `Weight (${modalUnit})`; });
            }

            function convertModalWeights(newUnit) {
                const oldUnit = modalUnit; if (oldUnit === newUnit) return;
                ui.workoutModal.querySelectorAll('.set-weight').forEach(input => { const currentValue = parseFloat(input.value); if (!isNaN(currentValue)) { if (newUnit === 'lbs' && oldUnit === 'kg') { input.value = kgToLbs(currentValue).toFixed(1); } else if (newUnit === 'kg' && oldUnit === 'lbs') { input.value = lbsToKg(currentValue).toFixed(1); } } });
                updateUnitToggleUI(newUnit);
            }

            ui.unitToggleKg.addEventListener('click', () => convertModalWeights('kg'));
            ui.unitToggleLbs.addEventListener('click', () => convertModalWeights('lbs'));
            window.addEventListener('beforeunload', (e) => { if (isLogging) { e.preventDefault(); e.returnValue = ''; } });

            // --- AI Chat Functions ---
            function renderChatHistory() {
                const chatHistoryContainer = document.getElementById('ai-chat-history');
                if(workoutChatHistory.length === 0) { chatHistoryContainer.innerHTML = `<div class="text-center text-secondary-text p-4"><i data-lucide="bot" class="w-10 h-10 mx-auto mb-2"></i><p>Hello! I'm your AI Coach. Ask me anything about your workout plan, exercise form, or general fitness.</p></div>`; lucide.createIcons(); } 
                else { chatHistoryContainer.innerHTML = ''; workoutChatHistory.forEach(msg => { addMessageToChat(msg.parts[0].text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'), msg.role); }); }
            }

            function addMessageToChat(message, sender, isLoading = false) {
                const chatHistoryContainer = document.getElementById('ai-chat-history');
                if (workoutChatHistory.length === 1 && sender === 'user') { chatHistoryContainer.innerHTML = ''; }
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-3 rounded-lg max-w-[85%] ${sender === 'user' ? 'bg-blue-600 self-end' : 'bg-input-bg self-start'}`;
                if(isLoading) messageDiv.id = 'ai-loading-message';
                messageDiv.innerHTML = message;
                chatHistoryContainer.appendChild(messageDiv);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            }

             function updateLastMessage(newMessage) {
                 const loadingMessage = document.getElementById('ai-loading-message');
                 if (loadingMessage) {
                     loadingMessage.innerHTML = newMessage;
                     loadingMessage.removeAttribute('id');
                 }
             }

            async function handleAiChatSend() {
                const chatInput = document.getElementById('ai-chat-input'); const sendBtn = document.getElementById('ai-chat-send-btn');
                const userInput = chatInput.value.trim(); if(!userInput) return;
                workoutChatHistory.push({ role: "user", parts: [{ text: userInput }] }); addMessageToChat(userInput, 'user');
                chatInput.value = ''; sendBtn.disabled = true; addMessageToChat('<div class="loader"></div>', 'model', true);
                try {
                    const twoWeeksAgo = new Date(); twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                    const recentHistory = workoutHistory.filter(log => new Date(log.date) >= twoWeeksAgo).map(log => { const sets = typeof log.sets === 'string' ? JSON.parse(log.sets) : log.sets; return `On ${new Date(log.date.replace(/-/g, '/')).toLocaleDateString()}: ${log.name} - ${sets.map(s => s.map(p => `${p.weight}kg x ${p.reps}r`).join('/')).join(', ')}`; }).join('; ');
                    const context = ` User's Workout Plan: ${JSON.stringify(workoutPlan)} User's Exercise Library: ${exerciseDB.map(ex => `${ex.name} (${ex.group})`).join(', ')} Last 14 Days Workout History: ${recentHistory || "No workouts logged."} `;
                    const systemPrompt = `You are FitTrack AI, an expert fitness and workout coach. Analyze the user's provided data (plan, history, available exercises) to give specific, actionable advice based on their question. Be encouraging and provide clear, concise answers. Here is the user's data context: ${context}`;
                    const response = await fetch(getApiUrl('gemini-2.5-flash-preview-05-20'), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: workoutChatHistory, systemInstruction: { parts: [{ text: systemPrompt }] } }) });
                    if(!response.ok) throw new Error('Failed to get response from AI.'); const result = await response.json();
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    workoutChatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    updateLastMessage(aiResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'));
                } catch(error) { updateLastMessage('Sorry, I am having trouble connecting right now. Please try again later.');
                } finally { sendBtn.disabled = false; saveData(); }
            }
            
            ui.openWorkoutChatBtn.addEventListener('click', () => { renderChatHistory(); showModal(document.getElementById('ai-workout-chat-modal')); });
            document.getElementById('close-ai-workout-chat-modal-btn').addEventListener('click', () => hideModal(document.getElementById('ai-workout-chat-modal')));
            document.getElementById('ai-chat-send-btn').addEventListener('click', handleAiChatSend);
            document.getElementById('ai-chat-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') handleAiChatSend(); });

            ui.dayNavigationCard.addEventListener('mousedown', handleDayNavPointerDown);
            ui.dayNavigationCard.addEventListener('touchstart', handleDayNavPointerDown, { passive: true });
            
            // --- UI Cleanup Listeners removed ---

            // --- NEW: Permanent Edit Warning Listener ---
            ui.permanentEditOkBtn.addEventListener('click', () => {
                if (ui.permanentEditDontShowAgain.checked) {
                    userSettings.showPermanentEditWarning = false;
                    saveData();
                }
                hideModal(ui.permanentEditWarningModal);
                openEditPlanModal();
            });

            // --- NEW: Add Drag/Drop Listeners for Plan View Reordering ---
            ui.workoutPlanForDay.addEventListener('dragstart', handlePlanDragStart);
            ui.workoutPlanForDay.addEventListener('dragend', handlePlanDragEnd);
            ui.workoutPlanForDay.addEventListener('dragover', handlePlanDragOver);
            ui.workoutPlanForDay.addEventListener('drop', handlePlanDrop);


            // --- INITIALIZATION ---
            async function initializeApp() {
                // await openDB(); // Removed IndexedDB init
                await loadAllData();
                if (!workoutPlan || !workoutPlan.schedule || Object.keys(workoutPlan.schedule).length === 0) {
                    if (exerciseDB.length > 0) {
                        workoutPlan = {
                            name: "Optimized PPL",
                            schedule: { "Monday": "Push", "Tuesday": "Pull", "Wednesday": "Legs", "Thursday": "Push", "Friday": "Pull", "Saturday": "Legs", "Sunday": "Rest" },
                            workouts: [
                                { day: "Push", exercises: ["Dumbell Incline bench press", "Cable Tricep Pushdown", "Cable Forearm Straight bar Pull", "Machine Chest Press", "Cable Tricep Kickbacks", "Cable Forearm Curl"] },
                                { day: "Pull", exercises: ["Cable close grip Lat pulldowns", "Bayseian Bicep cable curls", "Cable lateral raises", "Machine bench supported rows", "Cable Hammer curls", "Cable shoulder press"] },
                                { day: "Legs", exercises: ["Leg extensions", "Leg curls", "Bodyweight captain chair leg raises", "Calf raises", "Hip thrust", "Hacksmith squats", "Cable ab crunches"] }
                            ],
                            restTime: 2
                        };
                        saveData();
                    }
                }
                updateUI();
                updateSplit(); // Initialize the AI plan schedule builder
                
                // Ensure double-click listener is attached to the title span on load
                document.getElementById('plan-main-title').addEventListener('dblclick', enableTitleEdit);
                lucide.createIcons();
            }

            initializeApp();
        });
    </script>
</body>
</html>
